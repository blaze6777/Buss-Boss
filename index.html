function allRoutes(){
  // built-in + custom
  return [...ROUTES, ...(state.customRoutes || [])];
}

function dailyRoutes(){
  // daily = not adhoc and not the built-in field trip
  return allRoutes().filter(r => !r.isAdhoc && r.id !== "field");
}

function adHocRoutes(){
  // ad-hoc = built-in field + anything flagged isAdhoc
  return allRoutes().filter(r => r.id === "field" || r.isAdhoc);
}

function addCustomRoute(){
  const name = document.getElementById("newRouteName").value.trim();
  const miles = Number(document.getElementById("newRouteMiles").value);
  const pay = Number(document.getElementById("newRoutePay").value);
  const wear = Number(document.getElementById("newRouteWear").value);
  const risk = Number(document.getElementById("newRouteRisk").value);
  const type = document.getElementById("newRouteType").value;

  if(!name) return alert("Enter a route name.");
  if(!(miles > 0) || !(wear > 0) || !(risk > 0)) return alert("Miles/Wear/Risk must be > 0.");

  const id = "c_" + uid().slice(0,8); // short-ish id

  state.customRoutes.push({
    id,
    name,
    miles: Math.round(miles),
    pay: Math.round(pay),
    wear: Number(wear.toFixed(2)),
    risk: Number(risk.toFixed(2)),
    isAdhoc: (type === "adhoc")
  });

  // Ensure route assignments key exists for new DAILY route
  if(type === "daily"){
    if(!state.routeAssignments) state.routeAssignments = {};
    state.routeAssignments[id] = state.routeAssignments[id] || "";
  }

  // Reset inputs
  document.getElementById("newRouteName").value = "";
  save();
  renderAll();
}

function deleteCustomRoute(routeId){
  if(!confirm("Delete this route?")) return;

  // remove route
  state.customRoutes = (state.customRoutes || []).filter(r => r.id !== routeId);

  // remove any assignment
  if(state.routeAssignments && routeId in state.routeAssignments){
    delete state.routeAssignments[routeId];
  }

  // remove any dispatch driver picks for that route
  if(state.dispatch){
    Object.keys(state.dispatch).forEach(day => {
      ["morning","afternoon"].forEach(shift => {
        if(state.dispatch[day]?.[shift]?.[routeId]) delete state.dispatch[day][shift][routeId];
      });
    });
  }

  save();
  renderAll();
}

function renderCustomRoutes(){
  const panel = document.getElementById("customRoutesPanel");
  if(!panel) return;

  const list = state.customRoutes || [];
  if(!list.length){
    panel.innerHTML = `<div class="muted">No custom routes yet.</div>`;
    return;
  }

  panel.innerHTML = `
    <table>
      <thead><tr><th>Route</th><th>Type</th><th class="right">Action</th></tr></thead>
      <tbody>
        ${list.map(r => `
          <tr>
            <td>
              <strong>${escapeHtml(r.name)}</strong>
              <div class="small muted">${r.miles} mi • +$${r.pay} • Wear x${r.wear} • Risk x${r.risk}</div>
            </td>
            <td>${r.isAdhoc ? "Ad-hoc" : "Daily"}</td>
            <td class="right nowrap">
              <button class="danger" onclick="deleteCustomRoute('${r.id}')">Delete</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
