<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bus Boss â€“ School Bus Management Sim</title>
  <style>
    :root { --bg:#0b1020; --card:#111a33; --text:#e8ecff; --muted:#aab3dd; --line:#26335f; --pill:#1a2550; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#070a14, #0b1020 35%, #070a14); color:var(--text); }
    header{ padding:18px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(7,10,20,.88); backdrop-filter: blur(8px); z-index:5; }
    h1{ font-size:18px; margin:0 0 6px 0; letter-spacing:.3px; }
    h3{ margin:0; }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px 40px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr .9fr; } }
    .card{ background:rgba(17,26,51,.88); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .split{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 4px 2px; }
    input, select, textarea{
      width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--line);
      background:#0b1430; color:var(--text); outline:none;
    }
    textarea{ min-height:38px; resize:vertical; }
    button{
      border:1px solid var(--line); background:#0c1a3d; color:var(--text);
      border-radius:10px; padding:9px 10px; cursor:pointer;
    }
    button:hover{ filter:brightness(1.08); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    button.primary{ background:#1a2a70; border-color:#2e3fa1; }
    button.danger{ background:#3a1230; border-color:#7a2d5a; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(26,37,80,.55);
      font-size:12px; color:var(--text);
    }
    .small{ font-size:12px; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--line); }
    th, td{ padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ font-size:12px; color:var(--muted); background:rgba(11,20,48,.65); text-align:left; }
    tr:last-child td{ border-bottom:none; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .cols{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .tag{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted); background:rgba(11,20,48,.5); margin-right:6px; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ğŸšŒ Bus Boss</h1>
        <div class="small muted">A fun school bus management sim (local-only, saves in your browser).</div>
      </div>
      <div class="row">
        <span class="pill">ğŸ’° Budget: <span id="walletTop" class="mono"></span></span>
        <span class="pill">ğŸ—“ï¸ School Day: <span id="gameDateTop" class="mono"></span></span>
        <span class="pill">ğŸ“… Game Year: <span id="gameYearTop" class="mono"></span></span>
        <button class="primary" onclick="nextSchoolDay()">â¡ï¸ Next School Day</button>
        <button onclick="backupData()">â¬‡ï¸ Backup</button>
        <button onclick="restoreData()">â¬†ï¸ Restore</button>
        <button class="danger" onclick="resetAll()">Reset</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div class="card">
      <div class="split">
        <h3>ğŸ“Ÿ Dispatch View</h3>
        <div class="row">
          <span class="pill">Today: <span id="dispatchDate"></span></span>
          <div>
            <label>Shift</label>
            <select id="dispatchShift" onchange="renderAll()">
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
            </select>
          </div>
          <button class="primary" onclick="runAllScheduled()">â–¶ï¸ Run All (Shift)</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" onclick="startSchoolDay()">ğŸŒ… Start School Day</button>
        <span class="pill">ğŸ“£ PR: <span id="prMeter" class="mono"></span>/100</span>
        <button onclick="viewComplaints()">ğŸ“¨ Complaints</button>
        <button onclick="runSurpriseAudit()">ğŸ•µï¸ Surprise Audit</button>
      </div>
      <div id="opsBanner" class="small muted" style="margin-top:8px;"></div>

      <div class="small muted" style="margin-top:8px;">
        Uses your assigned route buses. If an assigned bus is <b>DOWN</b>, you must pick a <b>Sub Bus</b>. Field Trips are ad-hoc.
      </div>
      <div id="dispatchPanel" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <div class="split">
        <h3>ğŸ—ºï¸ Route Assignments (Daily)</h3>
        <div class="small muted">These stay assigned until you change them.</div>
      </div>
      <div id="routeAssignmentsPanel" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <h3>â• Create a Route</h3>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;min-width:220px">
          <label>Route Name</label>
          <input id="newRouteName" placeholder="e.g., Midday Preschool Shuttle" />
        </div>
        <div style="min-width:140px">
          <label>Miles</label>
          <input id="newRouteMiles" type="number" min="1" value="20" />
        </div>
        <div style="min-width:140px">
          <label>Pay ($)</label>
          <input id="newRoutePay" type="number" min="0" value="150" />
        </div>
        <div style="min-width:140px">
          <label>Wear</label>
          <input id="newRouteWear" type="number" step="0.1" min="0.5" max="3" value="1.2" />
        </div>
        <div style="min-width:140px">
          <label>Risk</label>
          <input id="newRouteRisk" type="number" step="0.1" min="0.5" max="3" value="1.2" />
        </div>
        <div style="min-width:170px">
          <label>Type</label>
          <select id="newRouteType">
            <option value="daily">Daily (assign bus)</option>
            <option value="adhoc">Ad-hoc (like Field Trip)</option>
          </select>
        </div>
        <button class="primary" onclick="addCustomRoute()">Add Route</button>
      </div>
      <div class="small muted">Daily routes show up in Route Assignments + Dispatch. Ad-hoc routes show up below.</div>
      <div id="customRoutesPanel" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <h3>ğŸ—ºï¸ Ad-hoc Route Runner</h3>
      <div class="small muted" style="margin:6px 0 10px;">Field Trips + ad-hoc custom routes (pick bus + driver each time).</div>
      <div class="row">
        <div style="flex:1;min-width:180px">
          <label>Bus</label>
          <select id="routeBus"></select>
        </div>
        <div style="flex:1;min-width:180px">
          <label>Driver</label>
          <select id="routeDriver"></select>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Route</label>
          <select id="routeType"></select>
        </div>
        <button class="primary" onclick="runRoute()">Run Route</button>
      </div>

      <div class="hr"></div>

      <h3>âœ… Daily Bus Checks & Defects</h3>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;min-width:220px">
          <label>Bus</label>
          <select id="checkBus"></select>
        </div>
        <button class="primary" onclick="doPreTrip()">Pre-Trip</button>
        <button onclick="doAllPreTrips()">âœ… Pre-Trip ALL Buses</button>
        <button onclick="doPostTrip()">Post-Trip (No Defect)</button>
        <button class="danger" onclick="reportDefect()">ğŸš¨ Report Defect</button>
      </div>

      <div class="hr"></div>

      <h3>ğŸ§¾ Activity Log</h3>
      <div class="small muted" style="margin:6px 0 10px;">Latest 20 entries.</div>
      <div id="logPanel"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="card">
        <div class="split">
          <h3>ğŸšŒ Fleet</h3>
          <div class="row">
            <button onclick="refreshLot()">ğŸ”„ Refresh Bus Lot</button>
            <button onclick="holdBoardMeeting()">ğŸ—³ï¸ Board Meeting</button>
          </div>
        </div>

        <div class="cols" style="margin-top:10px;">
          <div>
            <label>Add Bus Name</label>
            <input id="busName" placeholder="e.g., Bus 12" />
          </div>
          <div>
            <label>In-service year</label>
            <input id="busYear" type="number" min="1980" max="2099" placeholder="e.g., 2012" />
          </div>
          <div>
            <label>Notes</label>
            <input id="busNotes" placeholder="optional" />
          </div>
          <div>
            <button class="primary" style="width:100%;" onclick="addBus()">Add Bus</button>
          </div>
        </div>

        <div id="fleetPanel" style="margin-top:12px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3>ğŸ”§ Garage</h3>
          <div class="pill">ğŸ’° Budget: <span id="walletGarage" class="mono"></span></div>
        </div>
        <div id="garage" style="margin-top:10px;"></div>
        <div class="small muted" style="margin-top:8px;">
          Repairs clear DOWN status. Service boosts reliability. Upgrades permanently reduce breakdown chance.
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3>ğŸšŒ Thomas Built Bus Lot</h3>
          <div class="row">
            <div class="pill">ğŸ“… Year: <span id="gameYear"></span></div>
            <button onclick="advanceYear()">â¡ï¸ Next Year</button>
            <button onclick="refreshLot()">ğŸ”„ Refresh Lot</button>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px;">New lineup each year. Buying adds buses to your fleet.</div>
        <div id="busLot" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3>ğŸ‘©â€âœˆï¸ Drivers</h3>
          <div class="row">
            <button onclick="openHiringPool()">ğŸ¤ Hiring Pool (Pick 1 of 3)</button>
            <button onclick="openTrainingProgram()">ğŸ“ Training Program (Pick 1 Rookie)</button>
          </div>
        </div>

        <div class="cols" style="margin-top:10px;">
          <div>
            <label>Add Driver Name</label>
            <input id="driverName" placeholder="e.g., Sam Carter" />
          </div>
          <div>
            <label>Nickname</label>
            <input id="driverNick" placeholder='"Mirror Master"' />
          </div>
          <div>
            <label>Started driving (year)</label>
            <input id="driverYear" type="number" min="1980" max="2099" placeholder="e.g., 2016" />
          </div>
          <div>
            <button class="primary" style="width:100%;" onclick="addDriver()">Add Driver</button>
          </div>
        </div>

        <div id="driversPanel" style="margin-top:12px;"></div>
        <div id="hiringPanel" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3>ğŸ« School Board</h3>
          <div class="pill">Policy: <span id="boardPolicy"></span></div>
        </div>
        <div id="boardPanel" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3>ğŸ’ School Year (Option B)</h3>
          <div class="row">
            <button onclick="startNewSchoolYear(new Date().getFullYear())">ğŸ’ Start New School Year</button>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px;">Auto-prompts once per year on/after your configured start date (default Aug 1).</div>
        <div class="row" style="margin-top:10px;">
          <div style="min-width:160px;">
            <label>Start Month</label>
            <input id="syMonth" type="number" min="1" max="12" />
          </div>
          <div style="min-width:160px;">
            <label>Start Day</label>
            <input id="syDay" type="number" min="1" max="31" />
          </div>
          <button onclick="saveSchoolYearSettings()">Save</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE / HELPERS
========================= */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function load(){ try{ const raw = localStorage.getItem("busboss_v1"); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
function save(){ localStorage.setItem("busboss_v1", JSON.stringify(state)); }
function byId(arr, id){ return (arr||[]).find(x=>x.id===id); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* =========================
   GAME DATA
========================= */
const ROUTES = [
  // Daily routes
  { id:"neighborhood", name:"Neighborhood Route", miles:18, pay:120, wear:1.0, risk:1.0 },
  { id:"rural",        name:"Rural Route",        miles:42, pay:220, wear:1.4, risk:1.3 },
  { id:"special",      name:"Special Ed Route",   miles:22, pay:180, wear:1.6, risk:1.4 },
  { id:"midday_k",     name:"Midday Kindergarten Shuttle", miles:10, pay:80, wear:0.9, risk:0.9 },
  { id:"vo_tech",      name:"Vo-Tech / Career Center",     miles:34, pay:210, wear:1.3, risk:1.2 },
  { id:"late_run",     name:"Late Bus (After-School)",     miles:26, pay:170, wear:1.2, risk:1.2 },

  // Ad-hoc routes
  { id:"field",  name:"Field Trip",        miles:85, pay:420, wear:1.8, risk:1.6, isAdhoc:true },
  { id:"sports", name:"Sports Away Game",  miles:60, pay:320, wear:1.6, risk:1.5, isAdhoc:true }
];

const SHIFT_RULES = {
  morning:   { payMult: 1.00, wearMult: 1.00 },
  afternoon: { payMult: 0.95, wearMult: 1.05 }
};
const SUB_LATE_PENALTY = 25;

/* =========================
   STATE
========================= */
const state = load() || {
  wallet: 5000,
  gameYear: new Date().getFullYear(),
  gameDate: todayISO(),
  lotInventory: [],
  buses: [],
  drivers: [],
  logs: [],
  routeAssignments: {},         // { routeId: busId }
  dispatch: {},                 // { dateKey: { morning:{routeId:{driverId}}, afternoon:{...} } }
  hiring: { pool: [] },
  customRoutes: [],

  board: {
    lastMeetingKey: null,
    maintenanceMultiplier: 1.0,
    inspectionStrictness: 1.0,
    driverPolicy: "standard",
    nextYearAllocationMod: 1.0,
    breakdownMod: 1.0,
    conditionWearMod: 1.0,
    subCostPerRoute: 0
  },
  schoolYear: { startMonth: 8, startDay: 1, lastStartedYear: null },

  ops: {
    dayStartedKey: null,
    absentDrivers: [],
    lateDrivers: [],
    prScore: 70,
    complaints: {},
    audits: {}
  },
  busDayFlags: {}
};

function allTraits(){
  return [
    { id:"gentle", name:"Gentle on Equipment" },
    { id:"safe", name:"Safety First" },
    { id:"efficient", name:"Efficient Router" },
    { id:"rough", name:"Heavy Foot" },
    { id:"rookie", name:"Newbie Nerves" },
    { id:"steady", name:"Steady Hand" }
  ];
}
function traitById(id){ return allTraits().find(t=>t.id===id) || allTraits()[0]; }
function randomDriverTrait(){ return pick(allTraits()); }

function normalizeState(){
  const thisYear = new Date().getFullYear();

  if(typeof state.wallet !== "number") state.wallet = 5000;
  if(typeof state.gameYear !== "number") state.gameYear = thisYear;
  if(!state.gameDate) state.gameDate = todayISO();

  if(!Array.isArray(state.buses)) state.buses = [];
  if(!Array.isArray(state.drivers)) state.drivers = [];
  if(!Array.isArray(state.logs)) state.logs = [];
  if(!Array.isArray(state.lotInventory)) state.lotInventory = [];
  if(!Array.isArray(state.customRoutes)) state.customRoutes = [];
  if(!state.routeAssignments) state.routeAssignments = {};
  if(!state.dispatch) state.dispatch = {};
  if(!state.hiring) state.hiring = { pool: [] };
  if(!Array.isArray(state.hiring.pool)) state.hiring.pool = [];

  if(!state.board) state.board = {};
  if(!("lastMeetingKey" in state.board)) state.board.lastMeetingKey = null;
  if(!("maintenanceMultiplier" in state.board)) state.board.maintenanceMultiplier = 1.0;
  if(!("inspectionStrictness" in state.board)) state.board.inspectionStrictness = 1.0;
  if(!("driverPolicy" in state.board)) state.board.driverPolicy = "standard";
  if(!("nextYearAllocationMod" in state.board)) state.board.nextYearAllocationMod = 1.0;
  if(!("breakdownMod" in state.board)) state.board.breakdownMod = 1.0;
  if(!("conditionWearMod" in state.board)) state.board.conditionWearMod = 1.0;
  if(!("subCostPerRoute" in state.board)) state.board.subCostPerRoute = 0;

  if(!state.schoolYear) state.schoolYear = { startMonth: 8, startDay: 1, lastStartedYear: null };
  if(!("startMonth" in state.schoolYear)) state.schoolYear.startMonth = 8;
  if(!("startDay" in state.schoolYear)) state.schoolYear.startDay = 1;
  if(!("lastStartedYear" in state.schoolYear)) state.schoolYear.lastStartedYear = null;

  if(!state.ops) state.ops = {};
  if(!("dayStartedKey" in state.ops)) state.ops.dayStartedKey = null;
  if(!Array.isArray(state.ops.absentDrivers)) state.ops.absentDrivers = [];
  if(!Array.isArray(state.ops.lateDrivers)) state.ops.lateDrivers = [];
  if(typeof state.ops.prScore !== "number") state.ops.prScore = 70;
  if(!state.ops.complaints) state.ops.complaints = {};
  if(!state.ops.audits) state.ops.audits = {};
  if(!state.busDayFlags) state.busDayFlags = {};

  state.buses.forEach(b=>{
    if(!("assignedDriverId" in b)) b.assignedDriverId = null;
    if(!("status" in b)) b.status = "active"; // active | down
    if(!("maintenanceNote" in b)) b.maintenanceNote = "";
    if(!("subBusId" in b)) b.subBusId = null;

    if(!("inServiceYear" in b)) b.inServiceYear = thisYear;
    if(!("odometer" in b)) b.odometer = 0;

    if(!("condition" in b)) b.condition = 70;
    if(!("reliabilityMod" in b)) b.reliabilityMod = 0;
    if(!("serviceBoost" in b)) b.serviceBoost = 0;

    if(!("lastPreTripDate" in b)) b.lastPreTripDate = null;
    if(!("lastPostTripDate" in b)) b.lastPostTripDate = null;
    if(!("preTripStreak" in b)) b.preTripStreak = 0;

    if(!("defect" in b)) b.defect = null;
  });

  state.drivers.forEach(d=>{
    if(!("status" in d)) d.status = "available"; // available | vacation | sick
    if(!("hiredYear" in d)) d.hiredYear = state.gameYear;
    if(!("trait" in d)) d.trait = randomDriverTrait();
    if(!("isRetired" in d)) d.isRetired = false;
    if(!("retiredYear" in d)) d.retiredYear = null;
  });

  // Ensure assignment slots for daily routes
  dailyRoutes().forEach(r=>{
    if(!(r.id in state.routeAssignments)) state.routeAssignments[r.id] = "";
  });

  if(!state.lotInventory.length) generateLotForYear(state.gameYear);
}
normalizeState();
save();

/* =========================
   DAY CONTROL
========================= */
function dispatchKey(){ return state.gameDate; }
function nextSchoolDay(){
  let d = new Date(state.gameDate + "T00:00:00");
  do { d.setDate(d.getDate() + 1); } while (d.getDay()===0 || d.getDay()===6);
  state.gameDate = d.toISOString().slice(0,10);
  ensureDispatchDay();
  state.ops.dayStartedKey = null;
  save(); renderAll();
}

/* =========================
   ROUTES (BUILT + CUSTOM)
========================= */
function allRoutes(){ return [...ROUTES, ...(state.customRoutes||[])]; }
function dailyRoutes(){ return allRoutes().filter(r => !r.isAdhoc && r.id !== "field"); }
function adHocRoutes(){ return allRoutes().filter(r => r.id === "field" || r.isAdhoc); }

/* =========================
   CUSTOM ROUTES
========================= */
function addCustomRoute(){
  const name = document.getElementById("newRouteName").value.trim();
  const miles = Number(document.getElementById("newRouteMiles").value);
  const pay = Number(document.getElementById("newRoutePay").value);
  const wear = Number(document.getElementById("newRouteWear").value);
  const risk = Number(document.getElementById("newRouteRisk").value);
  const type = document.getElementById("newRouteType").value;

  if(!name) return alert("Enter a route name.");
  if(!(miles>0) || !(wear>0) || !(risk>0)) return alert("Miles/Wear/Risk must be > 0.");

  const id = "c_" + uid().slice(0,8);
  state.customRoutes.push({ id, name, miles: Math.round(miles), pay: Math.round(pay), wear:+wear.toFixed(2), risk:+risk.toFixed(2), isAdhoc:(type==="adhoc") });
  if(type==="daily") state.routeAssignments[id] = state.routeAssignments[id] || "";
  document.getElementById("newRouteName").value = "";
  save(); renderAll();
}
function deleteCustomRoute(routeId){
  if(!confirm("Delete this route?")) return;
  state.customRoutes = (state.customRoutes||[]).filter(r=>r.id!==routeId);
  if(routeId in state.routeAssignments) delete state.routeAssignments[routeId];
  Object.keys(state.dispatch||{}).forEach(day=>{
    ["morning","afternoon"].forEach(shift=>{
      if(state.dispatch[day]?.[shift]?.[routeId]) delete state.dispatch[day][shift][routeId];
    });
  });
  save(); renderAll();
}

/* =========================
   OPS REALISM (call-offs, deadhead, complaints, audits)
========================= */
function ensureOpsForDay(dayKey){
  if(!state.ops.complaints[dayKey]) state.ops.complaints[dayKey] = [];
  if(!state.busDayFlags[dayKey]) state.busDayFlags[dayKey] = {};
}
function opsBannerText(dayKey){
  const absent = state.ops.absentDrivers.length;
  const late = state.ops.lateDrivers.length;
  const started = state.ops.dayStartedKey === dayKey ? "âœ… Started" : "â³ Not started";
  return `${started} â€¢ Absences: ${absent} â€¢ Late: ${late}`;
}
function startSchoolDay(){
  const dayKey = dispatchKey();
  ensureOpsForDay(dayKey);
  if(state.ops.dayStartedKey === dayKey) return alert("School day already started.");

  state.ops.absentDrivers = [];
  state.ops.lateDrivers = [];

  const activeDrivers = state.drivers.filter(d=>!d.isRetired);
  const absentRate = 0.07;
  const lateRate = 0.10;

  activeDrivers.forEach(d=>{
    if(d.status !== "available") return;
    if(Math.random() < absentRate){
      d.status = "sick";
      state.ops.absentDrivers.push(d.id);
    }else if(Math.random() < lateRate){
      state.ops.lateDrivers.push(d.id);
    }
  });

  state.ops.dayStartedKey = dayKey;

  if(Math.random() < 0.12) autoAudit(dayKey, true);
  state.ops.prScore = clamp(state.ops.prScore + randInt(-2,2), 0, 100);

  state.logs.push({ id: uid(), busId:"", date: dayKey, miles:0, note:`ğŸŒ… School day started â€¢ Call-offs: ${state.ops.absentDrivers.length} â€¢ Late: ${state.ops.lateDrivers.length}`, createdAt: Date.now() });

  save(); renderAll();
  alert(`ğŸŒ… Day Started: ${dayKey}\nCall-offs: ${state.ops.absentDrivers.length}\nLate: ${state.ops.lateDrivers.length}`);
}
function viewComplaints(){
  const dayKey = dispatchKey();
  ensureOpsForDay(dayKey);
  const list = state.ops.complaints[dayKey];
  if(!list.length) return alert(`No complaints for ${dayKey} ğŸ‰`);
  const text = list.slice(-15).map((c,i)=>`${i+1}) ${c.type}: ${c.msg}`).join("\n");
  alert(`ğŸ“¨ Complaints (${dayKey})\n\n${text}`);
}
function addComplaint(type,msg){
  const dayKey = dispatchKey();
  ensureOpsForDay(dayKey);
  state.ops.complaints[dayKey].push({ type, msg, createdAt: Date.now() });

  const impact =
    type==="Late" ? -3 :
    type==="Dirty Bus" ? -4 :
    type==="Rough Ride" ? -2 :
    type==="No-Show" ? -8 :
    type==="Audit" ? -2 : -1;

  state.ops.prScore = clamp(state.ops.prScore + impact, 0, 100);
  if(type==="No-Show" || type==="Dirty Bus"){
    state.logs.push({ id: uid(), busId:"", date: dayKey, miles:0, note:`ğŸ“¨ Complaint: ${type} â€” ${msg}`, createdAt: Date.now() });
  }
}
function runSurpriseAudit(){ autoAudit(dispatchKey(), false); save(); renderAll(); }
function autoAudit(dayKey, wasAuto){
  ensureOpsForDay(dayKey);
  const buses = state.buses;
  const active = buses.filter(b=>b.status==="active");
  const preTripDone = active.filter(b=>b.lastPreTripDate===dayKey).length;
  const preTripPct = active.length ? preTripDone/active.length : 1;
  const majorDefects = buses.filter(b=>b.defect && b.defect.level==="major").length;
  const downBuses = buses.filter(b=>b.status==="down").length;

  let score = 100;
  score -= Math.round((1-preTripPct)*40);
  score -= majorDefects*8;
  score -= downBuses*4;
  score = clamp(score, 0, 100);

  const notes = [];
  notes.push(`Pre-Trip completion: ${Math.round(preTripPct*100)}%`);
  if(majorDefects) notes.push(`Major defects open: ${majorDefects}`);
  if(downBuses) notes.push(`Buses DOWN: ${downBuses}`);

  state.ops.audits[dayKey] = { score, notes, createdAt: Date.now() };

  if(score >= 90){
    state.ops.prScore = clamp(state.ops.prScore + 2, 0, 100);
    alert(`${wasAuto ? "ğŸ•µï¸ Surprise Audit (auto)" : "ğŸ•µï¸ Surprise Audit"}: ${score}/100\n\n${notes.join("\n")}`);
    return;
  }
  if(score < 70){
    const penalty = 150;
    state.wallet = Math.max(0, state.wallet - penalty);
    addComplaint("Audit", `Audit score ${score}. Office got heat from the board.`);
    alert(`ğŸ•µï¸ Audit Result: ${score}/100\n-${penalty} budget (training / corrective action)\n\n${notes.join("\n")}`);
    return;
  }
  alert(`${wasAuto ? "ğŸ•µï¸ Surprise Audit (auto)" : "ğŸ•µï¸ Surprise Audit"}: ${score}/100\n\n${notes.join("\n")}`);
}

function ensureBusFlags(dayKey, busId){
  ensureOpsForDay(dayKey);
  if(!state.busDayFlags[dayKey][busId]) state.busDayFlags[dayKey][busId] = { am:false, pm:false };
  return state.busDayFlags[dayKey][busId];
}
function applyDeadheadIfNeeded(bus, shift){
  const dayKey = dispatchKey();
  const flags = ensureBusFlags(dayKey, bus.id);
  const deadheadMiles = 3;
  const wear = 0.8;

  if(shift==="morning" && !flags.am){
    flags.am = true;
    bus.odometer += deadheadMiles;
    bus.condition = Math.max(0, Number(bus.condition||70) - wear);
    state.logs.push({ id: uid(), busId: bus.id, date: dayKey, miles: deadheadMiles, note:`ğŸš Deadhead (AM): yard â†’ start`, createdAt: Date.now() });
  }
  if(shift==="afternoon" && !flags.pm){
    flags.pm = true;
    bus.odometer += deadheadMiles;
    bus.condition = Math.max(0, Number(bus.condition||70) - wear);
    state.logs.push({ id: uid(), busId: bus.id, date: dayKey, miles: deadheadMiles, note:`ğŸš Deadhead (PM): end â†’ yard`, createdAt: Date.now() });
  }
}
function maybeComplaint(bus, driver, usedSub, skippedPreTrip){
  const cond = Number(bus.condition||70);
  let pLate=0.04, pDirty=0.03, pRough=0.02;
  if(usedSub) pLate += 0.06;
  if(skippedPreTrip) pLate += 0.03;
  if(state.ops.lateDrivers.includes(driver.id)) pLate += 0.10;
  if(cond < 55) pDirty += 0.06;
  if(cond < 40) pDirty += 0.10;
  if(cond < 50) pRough += 0.05;

  if(Math.random() < pLate) addComplaint("Late", `${driver.name} ran late due to congestion / loading time.`);
  if(Math.random() < pDirty) addComplaint("Dirty Bus", `Parents complained bus looked messy or smelled off.`);
  if(Math.random() < pRough) addComplaint("Rough Ride", `Rough ride / hard stops report came in.`);
}

/* =========================
   SCHOOL YEAR (Option B)
========================= */
function saveSchoolYearSettings(){
  const m = Number(document.getElementById("syMonth").value);
  const d = Number(document.getElementById("syDay").value);
  if(!(m>=1 && m<=12 && d>=1 && d<=31)) return alert("Enter a valid month/day.");
  state.schoolYear.startMonth = m;
  state.schoolYear.startDay = d;
  save(); renderAll();
}
function maybeAutoStartNewSchoolYear(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const d = now.getDate();
  const { startMonth, startDay, lastStartedYear } = state.schoolYear;
  const pastStart = (m>startMonth) || (m===startMonth && d>=startDay);
  if(pastStart && lastStartedYear !== y){
    const ok = confirm(`ğŸ“… New School Year Time!\nStart the ${y}-${y+1} school year now?`);
    state.schoolYear.lastStartedYear = y;
    save();
    if(ok) startNewSchoolYear(y);
  }
}
function startNewSchoolYear(startYear){
  state.gameYear = startYear;
  state.dispatch = {};
  const mod = state.board.nextYearAllocationMod || 1.0;
  const allocation = Math.round(2500 * mod);
  state.wallet = Math.round(state.wallet + allocation);
  generateLotForYear(state.gameYear);
  save(); renderAll();
  alert(`ğŸ’ New School Year Started: ${startYear}-${startYear+1}\nğŸ’° Allocation: +$${allocation.toLocaleString()}`);
}

/* =========================
   BUS LOT (Thomas Built)
========================= */
function msrpFor(year, trim){
  const base = 98000 + (year-2018)*1800;
  const trimAdd = trim==="HDX" ? 11000 : trim==="C2" ? 7000 : 0;
  return Math.round(base + trimAdd);
}
function makeLotBus(year){
  const trimShort = pick(["EFX","C2","HDX"]);
  const model = trimShort==="EFX" ? "Saf-T-Liner EFX" : trimShort==="C2" ? "Saf-T-Liner C2" : "Saf-T-Liner HDX";
  const funNames = ["Yellow Thunder","Route Rocket","Kindergarten Cruiser","Field Trip King","The Honk Machine","Pothole Warrior","Sunrise Express","After-School Shuttle"];
  const condition = randInt(92,100);
  const price = msrpFor(year, trimShort) - (100-condition)*350;
  return { lotId: uid(), make:"Thomas Built Buses", model, year, name:`New ${year} ${trimShort} â€¢ ${pick(funNames)}`, price: Math.round(price), condition, warranty: randInt(2,5) };
}
function generateLotForYear(year){
  const list = [];
  for(let i=0;i<6;i++) list.push(makeLotBus(year));
  if(Math.random()<0.6){
    const leftovers = randInt(1,2);
    for(let i=0;i<leftovers;i++){
      const b = makeLotBus(year-1);
      b.name = `Leftover ${b.year} Deal â€¢ ${b.name.split("â€¢").slice(-1)[0].trim()}`;
      b.price = Math.round(b.price*0.90);
      list.push(b);
    }
  }
  state.lotInventory = list;
}
function refreshLot(){ generateLotForYear(state.gameYear); save(); renderAll(); }
function buyLotBus(lotId){
  const item = state.lotInventory.find(x=>x.lotId===lotId);
  if(!item) return;
  if(state.wallet < item.price) return alert(`Not enough budget. Costs $${item.price.toLocaleString()}.`);
  state.wallet -= item.price;

  state.buses.push({
    id: uid(),
    name: item.name,
    notes: `${item.make} â€¢ ${item.model} â€¢ Warranty: ${item.warranty}yr`,
    status:"active",
    maintenanceNote:"",
    subBusId:null,
    inServiceYear:item.year,
    odometer:0,
    condition:item.condition,
    reliabilityMod:0.05,
    serviceBoost:10,
    lastPreTripDate:null,
    lastPostTripDate:null,
    preTripStreak:0,
    defect:null
  });
  state.lotInventory = state.lotInventory.filter(x=>x.lotId!==lotId);
  state.logs.push({ id: uid(), busId:"", date: dispatchKey(), miles:0, note:`ğŸšŒ Purchased: ${item.name} (-$${item.price.toLocaleString()})`, createdAt: Date.now() });
  save(); renderAll();
}

/* =========================
   BUSES / GARAGE
========================= */
function addBus(){
  const name = document.getElementById("busName").value.trim();
  const notes = document.getElementById("busNotes").value.trim();
  const year = Number(document.getElementById("busYear").value) || state.gameYear;
  if(!name) return alert("Enter a bus name.");
  state.buses.push({
    id: uid(), name, notes,
    status:"active", maintenanceNote:"", subBusId:null,
    inServiceYear:year, odometer:0,
    condition:70, reliabilityMod:0, serviceBoost:0,
    lastPreTripDate:null, lastPostTripDate:null, preTripStreak:0,
    defect:null
  });
  document.getElementById("busName").value="";
  document.getElementById("busNotes").value="";
  document.getElementById("busYear").value="";
  save(); renderAll();
}
function busAge(bus){ return Math.max(0, state.gameYear - Number(bus.inServiceYear||state.gameYear)); }

function repairCost(bus){
  const age = busAge(bus), odo = Number(bus.odometer||0);
  const base = 200 + age*35 + (odo/10000)*60;
  const downPenalty = bus.status==="down" ? 200 : 0;
  return Math.round((base + downPenalty) * (state.board.maintenanceMultiplier||1.0));
}
function serviceCost(bus){
  const age = busAge(bus);
  return Math.round((120 + age*15) * (state.board.maintenanceMultiplier||1.0));
}
function upgradeCost(bus){
  const age = busAge(bus);
  return Math.round((600 + age*80) * (state.board.maintenanceMultiplier||1.0));
}
function retireValue(bus){
  const age = busAge(bus), odo = Number(bus.odometer||0);
  const v = 700 - age*60 - (odo/10000)*50;
  return Math.max(50, Math.round(v));
}

function doRepair(busId){
  const bus = byId(state.buses,busId); if(!bus) return;
  const cost = repairCost(bus);
  if(state.wallet < cost) return alert(`Not enough budget. Repair costs $${cost}.`);
  state.wallet -= cost;
  bus.status="active"; bus.maintenanceNote=""; bus.subBusId=null; bus.defect=null;
  bus.condition = Math.min(100, Number(bus.condition||70)+20);
  state.logs.push({ id: uid(), busId: bus.id, date: dispatchKey(), miles:0, note:`ğŸ”§ Repair (-$${cost})`, createdAt: Date.now() });
  save(); renderAll();
}
function doService(busId){
  const bus = byId(state.buses,busId); if(!bus) return;
  const cost = serviceCost(bus);
  if(state.wallet < cost) return alert(`Not enough budget. Service costs $${cost}.`);
  state.wallet -= cost;
  bus.serviceBoost = Math.min(30, Number(bus.serviceBoost||0)+10);
  bus.condition = Math.min(100, Number(bus.condition||70)+10);
  state.logs.push({ id: uid(), busId: bus.id, date: dispatchKey(), miles:0, note:`ğŸ§½ Service (-$${cost})`, createdAt: Date.now() });
  save(); renderAll();
}
function doUpgrade(busId){
  const bus = byId(state.buses,busId); if(!bus) return;
  const cost = upgradeCost(bus);
  if(state.wallet < cost) return alert(`Not enough budget. Upgrade costs $${cost}.`);
  state.wallet -= cost;
  bus.reliabilityMod = Math.min(0.25, Number(bus.reliabilityMod||0)+0.05);
  bus.condition = Math.min(100, Number(bus.condition||70)+8);
  state.logs.push({ id: uid(), busId: bus.id, date: dispatchKey(), miles:0, note:`ğŸ§© Upgrade (-$${cost})`, createdAt: Date.now() });
  save(); renderAll();
}
function doRetireBus(busId){
  const bus = byId(state.buses,busId); if(!bus) return;
  const value = retireValue(bus);
  if(!confirm(`Retire "${bus.name}" for $${value}? This removes it and its logs.`)) return;
  state.wallet += value;
  state.buses = state.buses.filter(b=>b.id!==busId);
  state.logs = state.logs.filter(l=>l.busId!==busId);
  Object.keys(state.routeAssignments).forEach(k=>{ if(state.routeAssignments[k]===busId) state.routeAssignments[k]=""; });
  save(); renderAll();
}

/* =========================
   PRE/POST + DEFECT
========================= */
function doPreTrip(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses,busId); if(!bus) return;
  const t = dispatchKey();
  bus.lastPreTripDate = t;
  bus.preTripStreak = (bus.preTripStreak||0)+1;
  bus.condition = Math.min(100, Number(bus.condition||70)+0.5);
  state.logs.push({ id: uid(), busId: bus.id, date: t, miles:0, note:"âœ… Pre-Trip completed", createdAt: Date.now() });
  save(); renderAll();
}
function doAllPreTrips(){
  const t = dispatchKey();
  const active = state.buses.filter(b=>b.status==="active");
  if(!active.length) return alert("No active buses to pre-trip.");
  const toUpdate = active.filter(b=>b.lastPreTripDate!==t);
  if(!toUpdate.length) return alert("All active buses already have Pre-Trip completed for today.");
  if(!confirm(`Complete Pre-Trip for ${toUpdate.length} active bus(es) for ${t}?`)) return;

  toUpdate.forEach(bus=>{
    bus.lastPreTripDate = t;
    bus.preTripStreak = (bus.preTripStreak||0)+1;
    bus.condition = Math.min(100, Number(bus.condition||70)+0.5);
  });
  state.logs.push({ id: uid(), busId:"", date:t, miles:0, note:`âœ… Bulk Pre-Trip completed for ${toUpdate.length} bus(es)`, createdAt: Date.now() });
  save(); renderAll();
}
function doPostTrip(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses,busId); if(!bus) return;
  const t = dispatchKey();
  bus.lastPostTripDate = t;
  bus.condition = Math.min(100, Number(bus.condition||70)+0.3);
  state.logs.push({ id: uid(), busId: bus.id, date:t, miles:0, note:"âœ… Post-Trip completed", createdAt: Date.now() });
  save(); renderAll();
}
function reportDefect(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses,busId); if(!bus) return;
  const note = prompt("Describe the defect:"); if(!note) return;
  const major = confirm("Is this a MAJOR defect?\nOK = Major (bus out of service)\nCancel = Minor");
  const t = dispatchKey();
  bus.defect = { level: major ? "major" : "minor", note, date: t };
  bus.lastPostTripDate = t;
  if(major){
    bus.status="down";
    bus.maintenanceNote="Reported defect";
  }
  state.logs.push({ id: uid(), busId: bus.id, date:t, miles:0, note:`ğŸš¨ Defect reported (${major?"MAJOR":"minor"}): ${note}`, createdAt: Date.now() });
  save(); renderAll();
}

/* =========================
   BREAKDOWNS (older buses break more)
========================= */
function maybeAutoBreakWithRoute(bus, route, skippedPreTrip){
  if(bus.status!=="active") return;

  const age = busAge(bus);
  const odo = Number(bus.odometer||0);
  const condition = clamp(Number(bus.condition||70), 0, 100);
  const reliabilityMod = clamp(Number(bus.reliabilityMod||0), 0, 0.25);
  const serviceBoost = clamp(Number(bus.serviceBoost||0), 0, 30);

  let chance = 0.02 + (age*0.009) + (odo/50000)*0.03;
  chance *= (route?.risk || 1.0);
  chance *= (1.15 - (condition/100)*0.45);
  chance *= (1 - reliabilityMod);
  chance *= (1 - serviceBoost/100);
  chance *= (state.board.breakdownMod || 1.0);

  if(bus.defect) chance *= (bus.defect.level==="major" ? 2.0 : 1.25);
  if(skippedPreTrip) chance *= 1.25;
  chance = Math.min(chance, 0.22);

  bus.serviceBoost = Math.max(0, serviceBoost - 2);
  bus.condition = Math.max(0, condition - (0.6 * (state.board.conditionWearMod||1.0)));

  if(Math.random() > chance) return;

  const activeBuses = state.buses.filter(b=>b.status==="active");
  if(activeBuses.length < 2){
    state.logs.push({ id: uid(), busId: bus.id, date: dispatchKey(), miles:0, note:`âš ï¸ Near-breakdown avoided (no sub available)`, createdAt: Date.now() });
    return;
  }

  const events = [
    "Oil leak suspected after route",
    "Brake squeal turned into a warning light",
    "Cooling system acting up",
    "Electrical gremlin (again)",
    "Transmission slipping (old bus problems)"
  ];
  const candidates = activeBuses.filter(b=>b.id!==bus.id);
  const subBus = pick(candidates);

  bus.status="down";
  bus.maintenanceNote = pick(events);
  bus.subBusId = subBus.id;

  state.logs.push({ id: uid(), busId: bus.id, date: dispatchKey(), miles:0, note:`ğŸš§ Breakdown: ${bus.maintenanceNote}`, createdAt: Date.now() });
}

/* =========================
   DRIVERS
========================= */
function driverExperienceYears(d){ return Math.max(0, state.gameYear - Number(d.hiredYear||state.gameYear)); }
function addDriver(){
  const name = document.getElementById("driverName").value.trim();
  const nick = document.getElementById("driverNick").value.trim();
  const hiredYear = Number(document.getElementById("driverYear").value) || state.gameYear;
  if(!name) return alert("Enter a driver name.");
  state.drivers.push({ id: uid(), name, nick, status:"available", hiredYear, trait: randomDriverTrait(), isRetired:false, retiredYear:null });
  document.getElementById("driverName").value="";
  document.getElementById("driverNick").value="";
  document.getElementById("driverYear").value="";
  save(); renderAll();
}
function setDriverStatus(driverId, status){
  const d = byId(state.drivers,driverId); if(!d) return;
  if(d.isRetired) return;
  d.status = status;
  save(); renderAll();
}
function retireDriver(driverId){
  const d = byId(state.drivers,driverId); if(!d) return;
  if(d.isRetired) return;
  if(!confirm(`Retire ${d.name}?`)) return;
  d.isRetired=true;
  d.retiredYear = state.gameYear;
  d.status="vacation";
  state.logs.push({ id: uid(), busId:"", date: dispatchKey(), miles:0, note:`ğŸ‰ Driver retired: ${d.name}`, createdAt: Date.now() });
  save(); renderAll();
}

/* =========================
   HIRING POOL
========================= */
function generateName(){
  const first = ["Pat","Casey","Jordan","Taylor","Morgan","Riley","Avery","Sam","Cameron","Drew","Jamie","Alex"];
  const last  = ["Johnson","Miller","Davis","Clark","Lopez","Nguyen","Patel","Baker","Reed","Santos","Price","Hall"];
  return `${pick(first)} ${pick(last)}`;
}
function generateNick(){
  const nick = ["Smooth Stops","Turn Signal","Mirror Master","Radio Pro","Calm Captain","Pothole Dodger","Snack Patrol"];
  return `"${pick(nick)}"`;
}
function generatePoolCandidate(){
  const pool = ["safe","gentle","efficient","steady","rookie","rough","safe","gentle","efficient"];
  const trait = traitById(pick(pool));
  const expYears = randInt(0,18);
  const hiredYear = state.gameYear - expYears;
  const cost = Math.round(200 + expYears*25 + (trait.id==="safe"?80:0) + (trait.id==="rough"?-40:0));
  return { candId: uid(), name: generateName(), nick: generateNick(), hiredYear, trait, hireCost: Math.max(120,cost) };
}
function openHiringPool(){
  state.hiring.pool = [generatePoolCandidate(), generatePoolCandidate(), generatePoolCandidate()];
  save(); renderAll();
}
function openTrainingProgram(){
  // simplified: still a "rookie" candidate
  const makeRookie = ()=>({
    candId: uid(),
    name: generateName(),
    nick: generateNick(),
    hiredYear: state.gameYear,
    trait: traitById("rookie"),
    hireCost: 80
  });
  state.hiring.pool = [makeRookie(), makeRookie(), makeRookie()];
  save(); renderAll();
}
function hireCandidate(candId){
  const c = state.hiring.pool.find(x=>x.candId===candId);
  if(!c) return;
  if(state.wallet < c.hireCost) return alert(`Not enough budget. Hiring costs $${c.hireCost.toLocaleString()}.`);
  state.wallet -= c.hireCost;
  state.drivers.push({ id: uid(), name:c.name, nick:c.nick, status:"available", hiredYear:c.hiredYear, trait:c.trait, isRetired:false, retiredYear:null });
  state.hiring.pool = [];
  state.logs.push({ id: uid(), busId:"", date: dispatchKey(), miles:0, note:`ğŸ‘©â€âœˆï¸ Hired: ${c.name} (-$${c.hireCost})`, createdAt: Date.now() });
  save(); renderAll();
}

/* =========================
   DISPATCH + ROUTE ASSIGNMENTS
========================= */
function getDispatchShift(){
  const el = document.getElementById("dispatchShift");
  return el && el.value ? el.value : "morning";
}
function ensureDispatchDay(){
  const key = dispatchKey();
  if(!state.dispatch[key]) state.dispatch[key] = { morning:{}, afternoon:{} };
  ["morning","afternoon"].forEach(shift=>{
    dailyRoutes().forEach(r=>{
      if(!state.dispatch[key][shift][r.id]) state.dispatch[key][shift][r.id] = { driverId:"" };
    });
  });
}
function setAssignedBus(routeId, busId){
  state.routeAssignments[routeId] = busId || "";
  save(); renderAll();
}
function setDispatchDriver(routeId, driverId){
  ensureDispatchDay();
  const key = dispatchKey();
  const shift = getDispatchShift();
  state.dispatch[key][shift][routeId].driverId = driverId || "";
  save(); renderAll();
}
function getDispatchDriver(routeId){
  ensureDispatchDay();
  const key = dispatchKey();
  const shift = getDispatchShift();
  return state.dispatch[key][shift]?.[routeId]?.driverId || "";
}

function pickSubBus(excludeBusId){
  const options = state.buses.filter(b=>b.status==="active" && b.id!==excludeBusId);
  if(!options.length) return null;
  const list = options.map((b,i)=>`${i+1}) ${b.name}`).join("\n");
  const choice = prompt(`Assigned bus is DOWN.\nPick a Sub Bus:\n\n${list}\n\nEnter number:`);
  const idx = Number(choice)-1;
  if(!Number.isFinite(idx) || idx<0 || idx>=options.length) return null;
  return options[idx];
}

/* =========================
   RUN ROUTES
========================= */
function runRoute(){ // AD-HOC
  const busId = document.getElementById("routeBus").value;
  const driverId = document.getElementById("routeDriver").value;
  const routeId = document.getElementById("routeType").value;
  const bus = byId(state.buses,busId);
  const driver = byId(state.drivers,driverId);
  const route = allRoutes().find(r=>r.id===routeId);
  if(!bus || !driver || !route) return alert("Select bus, driver, and route.");
  if(bus.status==="down") return alert("Bus is down. Use a different bus (or repair it).");
  if(driver.isRetired) return alert("Driver is retired.");
  if(driver.status!=="available") return alert(`${driver.name} is unavailable.`);

  const t = dispatchKey();
  const skippedPreTrip = (bus.lastPreTripDate !== t);
  if(skippedPreTrip && !confirm(`âš ï¸ Pre-Trip not completed for ${bus.name} today.\nRun anyway? (Higher risk)`)) return;

  const shift = getDispatchShift();
  const rules = SHIFT_RULES[shift] || SHIFT_RULES.morning;

  applyDeadheadIfNeeded(bus, shift);

  bus.odometer += route.miles;

  let wear = route.wear * 1.2 * rules.wearMult;
  if(skippedPreTrip) wear *= 1.15;
  if(bus.defect) wear *= (bus.defect.level==="major" ? 1.25 : 1.10);
  wear *= (state.board.conditionWearMod || 1.0);
  bus.condition = Math.max(0, Number(bus.condition||70) - wear);

  const pay = Math.round(route.pay * rules.payMult);
  state.wallet += pay;

  state.logs.push({ id: uid(), busId: bus.id, date:t, miles: route.miles, note:`ğŸ—ºï¸ ${route.name} (AD-HOC ${shift.toUpperCase()}) +$${pay}`, createdAt: Date.now() });

  maybeAutoBreakWithRoute(bus, route, skippedPreTrip);
  maybeComplaint(bus, driver, false, skippedPreTrip);

  save(); renderAll();
  alert(`ğŸšŒ ${route.name} completed!\nBus: ${bus.name}\nDriver: ${driver.name}\n+$${pay} â€¢ ${route.miles} miles`);
}

function runScheduledRouteWithDriver(routeId){
  const route = dailyRoutes().find(r=>r.id===routeId);
  if(!route) return;

  const assignedBusId = state.routeAssignments[routeId] || "";
  if(!assignedBusId) return alert(`No bus assigned to ${route.name}. Set it in Route Assignments.`);

  const busAssigned = byId(state.buses, assignedBusId);
  if(!busAssigned) return alert(`Assigned bus for ${route.name} no longer exists. Re-assign it.`);

  const driverId = getDispatchDriver(routeId);
  if(!driverId){
    addComplaint("No-Show", `${route.name} had no driver assigned for this shift.`);
    save(); renderAll();
    return alert(`ğŸš« NO DRIVER ASSIGNED\n${route.name}\n(Complaint added)`);
  }

  const driver = byId(state.drivers, driverId);
  if(!driver || driver.isRetired) return alert(`Driver missing/retired for ${route.name}.`);
  if(driver.status !== "available"){
    addComplaint("No-Show", `${driver.name} was unavailable for ${route.name} (status: ${driver.status}).`);
    save(); renderAll();
    return alert(`ğŸš« DRIVER UNAVAILABLE\n${driver.name} (${driver.status})`);
  }

  const shift = getDispatchShift();
  const rules = SHIFT_RULES[shift] || SHIFT_RULES.morning;

  // Sub bus logic
  let busToUse = busAssigned;
  let usedSub = false;

  if(busAssigned.status === "down"){
    const sub = pickSubBus(busAssigned.id);
    if(!sub){
      addComplaint("No-Show", `${route.name} bus was DOWN and no sub bus was selected.`);
      save(); renderAll();
      return alert(`ğŸš§ Assigned bus DOWN\nNo sub selected. Route not run.`);
    }
    busAssigned.subBusId = sub.id;
    busToUse = sub;
    usedSub = true;
    if(state.board.subCostPerRoute > 0) state.wallet = Math.max(0, state.wallet - state.board.subCostPerRoute);
  }

  const t = dispatchKey();
  const skippedPreTrip = (busToUse.lastPreTripDate !== t);
  if(skippedPreTrip){
    // if you want to force it, replace this confirm with "return alert(...)"
    if(!confirm(`âš ï¸ Pre-Trip not completed for ${busToUse.name} today.\nRun anyway? (Higher risk)`)) return;
  }

  applyDeadheadIfNeeded(busToUse, shift);

  // Apply route miles + wear + pay
  busToUse.odometer += route.miles;

  let wear = route.wear * rules.wear
