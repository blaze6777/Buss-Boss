<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bus Boss ‚Äì School Bus Management Sim</title>
  <style>
    :root { --bg:#0b1020; --card:#111a33; --text:#e8ecff; --muted:#aab3dd; --line:#26335f; --pill:#1a2550; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#070a14, #0b1020 35%, #070a14); color:var(--text); }
    header{ padding:18px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(7,10,20,.88); backdrop-filter: blur(8px); z-index:5; }
    h1{ font-size:18px; margin:0 0 6px 0; letter-spacing:.3px; }
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px 40px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr .9fr; } }
    .card{ background:rgba(17,26,51,.88); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .split{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 4px 2px; }
    input, select, textarea{
      width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--line);
      background:#0b1430; color:var(--text); outline:none;
    }
    textarea{ min-height:38px; resize:vertical; }
    button{
      border:1px solid var(--line); background:#0c1a3d; color:var(--text);
      border-radius:10px; padding:9px 10px; cursor:pointer;
    }
    button:hover{ filter:brightness(1.08); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    button.primary{ background:#1a2a70; border-color:#2e3fa1; }
    button.danger{ background:#3a1230; border-color:#7a2d5a; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(26,37,80,.55);
      font-size:12px; color:var(--text);
    }
    .small{ font-size:12px; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--line); }
    th, td{ padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ font-size:12px; color:var(--muted); background:rgba(11,20,48,.65); text-align:left; }
    tr:last-child td{ border-bottom:none; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .cols{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    a{ color:#b8c5ff; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>üöå Bus Boss</h1>
        <div class="small muted">A fun school bus management sim (local-only, saves in your browser).</div>
      </div>
      <div class="row">
        <span class="pill">üí∞ Budget: <span id="walletTop" class="mono"></span></span>
        <span class="pill">üìÖ Game Year: <span id="gameYearTop" class="mono"></span></span>
        <button onclick="backupData()">‚¨áÔ∏è Backup</button>
        <button onclick="restoreData()">‚¨ÜÔ∏è Restore</button>
        <button class="danger" onclick="resetAll()">Reset</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div class="card">
      <div class="split">
        <h3 style="margin:0;">üìü Dispatch View</h3>
        <div class="row">
          <div class="pill">Today: <span id="dispatchDate"></span></div>
          <div>
            <label>Shift</label>
            <select id="dispatchShift" onchange="renderAll()">
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
            </select>
          </div>
          <button class="primary" onclick="runAllScheduled()">‚ñ∂Ô∏è Run All (Shift)</button>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px;">
        Uses your assigned route buses. If an assigned bus is <b>DOWN</b>, you must choose a <b>Sub Bus</b>. Field Trips stay ad-hoc.
      </div>
      <div id="dispatchPanel" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <div class="split">
        <h3 style="margin:0;">üó∫Ô∏è Route Assignments (Daily)</h3>
        <div class="small muted">These stay assigned until you change them.</div>
      </div>
      <div id="routeAssignmentsPanel" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <!-- CREATE ROUTE -->
      <div class="card" style="margin-top:0;">
        <h3 style="margin:0;">‚ûï Create a Route</h3>
        <div class="row" style="margin-top:10px;">
          <div style="flex:1;min-width:220px">
            <label>Route Name</label>
            <input id="newRouteName" placeholder="e.g., Midday Preschool Shuttle" />
          </div>
          <div style="min-width:140px">
            <label>Miles</label>
            <input id="newRouteMiles" type="number" min="1" value="20" />
          </div>
          <div style="min-width:140px">
            <label>Pay ($)</label>
            <input id="newRoutePay" type="number" min="0" value="150" />
          </div>
          <div style="min-width:140px">
            <label>Wear</label>
            <input id="newRouteWear" type="number" step="0.1" min="0.5" max="3" value="1.2" />
          </div>
          <div style="min-width:140px">
            <label>Risk</label>
            <input id="newRouteRisk" type="number" step="0.1" min="0.5" max="3" value="1.2" />
          </div>
          <div style="min-width:170px">
            <label>Type</label>
            <select id="newRouteType">
              <option value="daily">Daily (assign bus)</option>
              <option value="adhoc">Ad-hoc (like Field Trip)</option>
            </select>
          </div>
          <button class="primary" onclick="addCustomRoute()">Add Route</button>
        </div>

        <div class="small muted">Daily routes show up in Route Assignments + Dispatch. Ad-hoc routes show up in the Ad-hoc runner.</div>
        <div id="customRoutesPanel" style="margin-top:10px;"></div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0;">üó∫Ô∏è Ad-hoc Route Runner</h3>
      <div class="small muted" style="margin:6px 0 10px;">Field Trips + ad-hoc custom routes (pick bus + driver each time).</div>
      <div class="row">
        <div style="flex:1;min-width:180px">
          <label>Bus</label>
          <select id="routeBus"></select>
        </div>
        <div style="flex:1;min-width:180px">
          <label>Driver</label>
          <select id="routeDriver"></select>
        </div>
        <div style="flex:1;min-width:200px">
          <label>Route</label>
          <select id="routeType"></select>
        </div>
        <button class="primary" onclick="runRoute()">Run Route</button>
      </div>
      <div class="small muted" style="margin-top:8px;">Routes earn money, add mileage, and wear down buses.</div>

      <div class="hr"></div>

      <h3 style="margin:0;">‚úÖ Daily Bus Checks & Defects</h3>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;min-width:220px">
          <label>Bus</label>
          <select id="checkBus"></select>
        </div>
        <button class="primary" onclick="doPreTrip()">Pre-Trip</button>
        <button onclick="doPostTrip()">Post-Trip (No Defect)</button>
        <button class="danger" onclick="reportDefect()">üö® Report Defect</button>
      </div>
      <div class="small muted" style="margin-top:8px;">
        Skipping Pre-Trip increases breakdown risk. Major defects put buses DOWN and force sub buses.
      </div>

      <div class="hr"></div>

      <h3 style="margin:0;">üßæ Activity Log</h3>
      <div class="small muted" style="margin:6px 0 10px;">Latest 20 entries.</div>
      <div id="logPanel"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="card">
        <div class="split">
          <h3 style="margin:0;">üöå Fleet</h3>
          <div class="row">
            <button onclick="refreshLot()">üîÑ Refresh Bus Lot</button>
            <button onclick="holdBoardMeeting()">üó≥Ô∏è Board Meeting</button>
          </div>
        </div>

        <div class="cols" style="margin-top:10px;">
          <div>
            <label>Add Bus Name</label>
            <input id="busName" placeholder="e.g., Bus 12" />
          </div>
          <div>
            <label>In-service year</label>
            <input id="busYear" type="number" min="1980" max="2099" placeholder="e.g., 2012" />
          </div>
          <div>
            <label>Notes</label>
            <input id="busNotes" placeholder="optional" />
          </div>
          <div>
            <button class="primary" style="width:100%;" onclick="addBus()">Add Bus</button>
          </div>
        </div>

        <div id="fleetPanel" style="margin-top:12px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3 style="margin:0;">üîß Garage</h3>
          <div class="pill">üí∞ Budget: <span id="walletGarage" class="mono"></span></div>
        </div>
        <div id="garage"></div>
        <div class="small muted" style="margin-top:8px;">
          Repairs clear DOWN status. Oil/Tires/Brakes reset maintenance intervals. Servicing boosts reliability for a while. Upgrades permanently reduce breakdown chance.
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3 style="margin:0;">üöå Thomas Built Bus Lot</h3>
          <div class="row">
            <div class="pill">üìÖ Year: <span id="gameYear"></span></div>
            <button onclick="advanceYear()">‚û°Ô∏è Next Year</button>
            <button onclick="refreshLot()">üîÑ Refresh Lot</button>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px;">
          New lineup each year. Buying adds buses to your fleet with strong condition and reliability.
        </div>
        <div id="busLot" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3 style="margin:0;">üë©‚Äç‚úàÔ∏è Drivers</h3>
          <div class="row">
            <button onclick="openHiringPool()">üé§ Hiring Pool (Pick 1 of 3)</button>
            <button onclick="openTrainingProgram()">üéì Training Program (Pick 1 Rookie)</button>
          </div>
        </div>

        <div class="cols" style="margin-top:10px;">
          <div>
            <label>Add Driver Name</label>
            <input id="driverName" placeholder="e.g., Sam Carter" />
          </div>
          <div>
            <label>Nickname</label>
            <input id="driverNick" placeholder='"Mirror Master"' />
          </div>
          <div>
            <label>Started driving (year)</label>
            <input id="driverYear" type="number" min="1980" max="2099" placeholder="e.g., 2016" />
          </div>
          <div>
            <button class="primary" style="width:100%;" onclick="addDriver()">Add Driver</button>
          </div>
        </div>

        <div id="driversPanel" style="margin-top:12px;"></div>

        <div id="hiringPanel" style="margin-top:10px;"></div>

        <div class="card" style="margin-top:10px;">
          <h4 style="margin:0 0 8px;">ü§ù Mentor Pairing</h4>
          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Trainee</label>
              <select id="mentorTrainee"></select>
            </div>
            <div style="flex:1; min-width:220px;">
              <label>Mentor (5+ yrs)</label>
              <select id="mentorMentor"></select>
            </div>
            <button class="primary" onclick="setMentor()">Assign Mentor</button>
            <button onclick="clearMentor()">Clear Mentor</button>
          </div>
          <div class="small muted">Mentors reduce training incidents and improve graduation outcomes.</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3 style="margin:0;">üè´ School Board</h3>
          <div class="pill">Policy: <span id="boardPolicy"></span></div>
        </div>
        <div id="boardPanel" style="margin-top:10px;"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="split">
          <h3 style="margin:0;">üéí School Year (Option B)</h3>
          <div class="row">
            <button onclick="startNewSchoolYear(new Date().getFullYear())">üéí Start New School Year</button>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px;">
          Auto-prompts once per year on/after your configured start date (default: Aug 1).
        </div>
        <div class="row" style="margin-top:10px;">
          <div style="min-width:160px;">
            <label>Start Month</label>
            <input id="syMonth" type="number" min="1" max="12" />
          </div>
          <div style="min-width:160px;">
            <label>Start Day</label>
            <input id="syDay" type="number" min="1" max="31" />
          </div>
          <button onclick="saveSchoolYearSettings()">Save</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   CORE STORAGE / HELPERS
========================= */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function load(){
  try{
    const raw = localStorage.getItem("busboss_v1");
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function save(){
  localStorage.setItem("busboss_v1", JSON.stringify(state));
}

function byId(arr, id){ return (arr || []).find(x => x.id === id); }

function fmtMiles(n){
  const v = Math.round(Number(n||0));
  return v.toLocaleString();
}

function todayISO(){ return new Date().toISOString().slice(0,10); }

/* =========================
   GAME CONSTANTS
========================= */
const ROUTES = [
  // Daily routes
  { id:"neighborhood", name:"Neighborhood Route",           miles:18, pay:120, wear:1.0, risk:1.0 },
  { id:"rural",        name:"Rural Route",                  miles:42, pay:220, wear:1.4, risk:1.3 },
  { id:"special",      name:"Special Ed Route",             miles:22, pay:180, wear:1.6, risk:1.4 },

  // A few extra built-ins (daily)
  { id:"midday_k",     name:"Midday Kindergarten Shuttle",  miles:10, pay:80,  wear:0.9, risk:0.9 },
  { id:"vo_tech",      name:"Vo-Tech / Career Center",      miles:34, pay:210, wear:1.3, risk:1.2 },
  { id:"late_run",     name:"Late Bus (After-School)",      miles:26, pay:170, wear:1.2, risk:1.2 },

  // Ad-hoc routes
  { id:"field",        name:"Field Trip",                   miles:85, pay:420, wear:1.8, risk:1.6, isAdhoc:true },
  { id:"sports",       name:"Sports Away Game",             miles:60, pay:320, wear:1.6, risk:1.5, isAdhoc:true }
];

const SHIFT_RULES = {
  morning:   { payMult: 1.00, wearMult: 1.00 },
  afternoon: { payMult: 0.95, wearMult: 1.05 }
};
const SUB_LATE_PENALTY = 25;

const MAINT_INTERVALS = { oil: 4000, tires: 30000, brakes: 18000 };

/* =========================
   STATE INIT / NORMALIZE
========================= */
const state = load() || {
  wallet: 5000,
  gameYear: new Date().getFullYear(),
  lotInventory: [],
  buses: [],
  drivers: [],
  logs: [],
  routeAssignments: {}, // { routeId: busId }
  dispatch: {},         // { "YYYY-MM-DD": { morning:{routeId:{driverId}}, afternoon:{...} } }
  hiring: { pool: [] },
  customRoutes: [],     // user-created routes
  board: {
    lastMeetingKey: null,
    maintenanceMultiplier: 1.0,
    inspectionStrictness: 1.0,
    driverPolicy: "standard",
    nextYearAllocationMod: 1.0,
    breakdownMod: 1.0,
    conditionWearMod: 1.0,
    subCostPerRoute: 0
  },
  schoolYear: { startMonth: 8, startDay: 1, lastStartedYear: null }
};

function randomDriverTrait(){
  const traits = [
    { id:"gentle", name:"Gentle on Equipment" },
    { id:"safe", name:"Safety First" },
    { id:"efficient", name:"Efficient Router" },
    { id:"rough", name:"Heavy Foot" },
    { id:"rookie", name:"Newbie Nerves" },
    { id:"steady", name:"Steady Hand" }
  ];
  return traits[Math.floor(Math.random()*traits.length)];
}

function traitById(id){
  const all = [
    { id:"gentle", name:"Gentle on Equipment" },
    { id:"safe", name:"Safety First" },
    { id:"efficient", name:"Efficient Router" },
    { id:"rough", name:"Heavy Foot" },
    { id:"rookie", name:"Newbie Nerves" },
    { id:"steady", name:"Steady Hand" }
  ];
  return all.find(t=>t.id===id) || all[0];
}

function normalizeState(){
  const thisYear = new Date().getFullYear();

  if(typeof state.wallet !== "number") state.wallet = 5000;
  if(typeof state.gameYear !== "number") state.gameYear = thisYear;

  if(!Array.isArray(state.buses)) state.buses = [];
  if(!Array.isArray(state.drivers)) state.drivers = [];
  if(!Array.isArray(state.logs)) state.logs = [];
  if(!Array.isArray(state.lotInventory)) state.lotInventory = [];
  if(!Array.isArray(state.customRoutes)) state.customRoutes = [];

  if(!state.routeAssignments) state.routeAssignments = {};
  if(!state.dispatch) state.dispatch = {};
  if(!state.hiring) state.hiring = { pool: [] };
  if(!Array.isArray(state.hiring.pool)) state.hiring.pool = [];

  if(!state.board) state.board = {};
  if(!("lastMeetingKey" in state.board)) state.board.lastMeetingKey = null;
  if(!("maintenanceMultiplier" in state.board)) state.board.maintenanceMultiplier = 1.0;
  if(!("inspectionStrictness" in state.board)) state.board.inspectionStrictness = 1.0;
  if(!("driverPolicy" in state.board)) state.board.driverPolicy = "standard";
  if(!("nextYearAllocationMod" in state.board)) state.board.nextYearAllocationMod = 1.0;
  if(!("breakdownMod" in state.board)) state.board.breakdownMod = 1.0;
  if(!("conditionWearMod" in state.board)) state.board.conditionWearMod = 1.0;
  if(!("subCostPerRoute" in state.board)) state.board.subCostPerRoute = 0;

  if(!state.schoolYear) state.schoolYear = { startMonth: 8, startDay: 1, lastStartedYear: null };
  if(!("startMonth" in state.schoolYear)) state.schoolYear.startMonth = 8;
  if(!("startDay" in state.schoolYear)) state.schoolYear.startDay = 1;
  if(!("lastStartedYear" in state.schoolYear)) state.schoolYear.lastStartedYear = null;

  state.buses.forEach(b => {
    if(!("assignedDriverId" in b)) b.assignedDriverId = null;
    if(!("status" in b)) b.status = "active";
    if(!("maintenanceNote" in b)) b.maintenanceNote = "";
    if(!("subBusId" in b)) b.subBusId = null;

    if(!("inServiceYear" in b)) b.inServiceYear = thisYear;
    if(!("odometer" in b)) b.odometer = 0;

    if(!("condition" in b)) b.condition = 70;
    if(!("reliabilityMod" in b)) b.reliabilityMod = 0;
    if(!("serviceBoost" in b)) b.serviceBoost = 0;

    if(!("lastInspectionYear" in b)) b.lastInspectionYear = null;
    if(!("inspectionStatus" in b)) b.inspectionStatus = "unknown";

    if(!("lastPreTripDate" in b)) b.lastPreTripDate = null;
    if(!("lastPostTripDate" in b)) b.lastPostTripDate = null;
    if(!("preTripStreak" in b)) b.preTripStreak = 0;

    if(!("defect" in b)) b.defect = null;

    if(!("maintenance" in b) || !b.maintenance) b.maintenance = { oilAt: 0, tiresAt: 0, brakesAt: 0 };
    if(!("oilAt" in b.maintenance)) b.maintenance.oilAt = 0;
    if(!("tiresAt" in b.maintenance)) b.maintenance.tiresAt = 0;
    if(!("brakesAt" in b.maintenance)) b.maintenance.brakesAt = 0;
  });

  state.drivers.forEach(d => {
    if(!("status" in d)) d.status = "available";
    if(!("hiredYear" in d)) d.hiredYear = state.gameYear;
    if(!("trait" in d)) d.trait = randomDriverTrait();
    if(!("training" in d)) d.training = null;
    if(!("mentorDriverId" in d)) d.mentorDriverId = null;
    if(!("badges" in d)) d.badges = [];
    if(!("isRetired" in d)) d.isRetired = false;
    if(!("retiredYear" in d)) d.retiredYear = null;
  });

  if(!state.lotInventory.length) generateLotForYear(state.gameYear);

  // Ensure assignment keys exist for built-in daily routes and any custom daily routes
  dailyRoutes().forEach(r=>{
    if(!(r.id in state.routeAssignments)) state.routeAssignments[r.id] = "";
  });
}
normalizeState();
save();

/* =========================
   ROUTE COLLECTIONS (BUILT-IN + CUSTOM)
========================= */
function allRoutes(){
  return [...ROUTES, ...(state.customRoutes || [])];
}
function dailyRoutes(){
  return allRoutes().filter(r => !r.isAdhoc && r.id !== "field");
}
function adHocRoutes(){
  return allRoutes().filter(r => r.id === "field" || r.isAdhoc);
}

/* =========================
   CUSTOM ROUTES (ADD/DELETE/RENDER)
========================= */
function addCustomRoute(){
  const name = document.getElementById("newRouteName").value.trim();
  const miles = Number(document.getElementById("newRouteMiles").value);
  const pay = Number(document.getElementById("newRoutePay").value);
  const wear = Number(document.getElementById("newRouteWear").value);
  const risk = Number(document.getElementById("newRouteRisk").value);
  const type = document.getElementById("newRouteType").value;

  if(!name) return alert("Enter a route name.");
  if(!(miles > 0) || !(wear > 0) || !(risk > 0)) return alert("Miles/Wear/Risk must be > 0.");

  const id = "c_" + uid().slice(0,8);

  state.customRoutes.push({
    id,
    name,
    miles: Math.round(miles),
    pay: Math.round(pay),
    wear: Number(wear.toFixed(2)),
    risk: Number(risk.toFixed(2)),
    isAdhoc: (type === "adhoc")
  });

  if(type === "daily"){
    if(!state.routeAssignments) state.routeAssignments = {};
    state.routeAssignments[id] = state.routeAssignments[id] || "";
  }

  document.getElementById("newRouteName").value = "";
  save();
  renderAll();
}

function deleteCustomRoute(routeId){
  if(!confirm("Delete this route?")) return;

  state.customRoutes = (state.customRoutes || []).filter(r => r.id !== routeId);

  if(state.routeAssignments && routeId in state.routeAssignments){
    delete state.routeAssignments[routeId];
  }

  if(state.dispatch){
    Object.keys(state.dispatch).forEach(day => {
      ["morning","afternoon"].forEach(shift => {
        if(state.dispatch[day]?.[shift]?.[routeId]) delete state.dispatch[day][shift][routeId];
      });
    });
  }

  save();
  renderAll();
}

function renderCustomRoutes(){
  const panel = document.getElementById("customRoutesPanel");
  if(!panel) return;

  const list = state.customRoutes || [];
  if(!list.length){
    panel.innerHTML = `<div class="muted">No custom routes yet.</div>`;
    return;
  }

  panel.innerHTML = `
    <table>
      <thead><tr><th>Route</th><th>Type</th><th class="right">Action</th></tr></thead>
      <tbody>
        ${list.map(r => `
          <tr>
            <td>
              <strong>${escapeHtml(r.name)}</strong>
              <div class="small muted">${r.miles} mi ‚Ä¢ +$${r.pay} ‚Ä¢ Wear x${r.wear} ‚Ä¢ Risk x${r.risk}</div>
            </td>
            <td>${r.isAdhoc ? "Ad-hoc" : "Daily"}</td>
            <td class="right nowrap">
              <button class="danger" onclick="deleteCustomRoute('${r.id}')">Delete</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* =========================
   SCHOOL YEAR (Option B)
========================= */
function saveSchoolYearSettings(){
  const m = Number(document.getElementById("syMonth").value);
  const d = Number(document.getElementById("syDay").value);
  if(!(m>=1 && m<=12 && d>=1 && d<=31)) return alert("Enter a valid month/day.");
  state.schoolYear.startMonth = m;
  state.schoolYear.startDay = d;
  save();
  renderAll();
}

function maybeAutoStartNewSchoolYear(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;
  const d = now.getDate();

  const { startMonth, startDay, lastStartedYear } = state.schoolYear;
  const pastStart = (m > startMonth) || (m === startMonth && d >= startDay);

  if(pastStart && lastStartedYear !== y){
    const ok = confirm(`üìÖ New School Year Time!\nStart the ${y}-${y+1} school year now?`);
    state.schoolYear.lastStartedYear = y;
    save();
    if(ok) startNewSchoolYear(y);
  }
}

function startNewSchoolYear(startYear){
  state.gameYear = startYear;
  state.dispatch = {};

  const mod = state.board?.nextYearAllocationMod || 1.0;
  const allocation = Math.round(2500 * mod);
  state.wallet = Math.round((state.wallet || 0) + allocation);

  generateLotForYear(state.gameYear);

  save();
  renderAll();

  alert(`üéí New School Year Started: ${startYear}-${startYear+1}\nüí∞ Allocation: +$${allocation.toLocaleString()}`);
}

/* =========================
   BUS LOT (Thomas Built)
========================= */
function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

function msrpFor(year, trim){
  const base = 98000 + (year - 2018) * 1800;
  const trimAdd = trim === "HDX" ? 11000 : trim === "C2" ? 7000 : 0;
  return Math.round(base + trimAdd);
}

function makeLotBus(year){
  const trims = ["Saf-T-Liner EFX", "Saf-T-Liner C2", "Saf-T-Liner HDX"];
  const trimShort = pick(["EFX","C2","HDX"]);
  const trimName = trimShort === "EFX" ? trims[0] : trimShort === "C2" ? trims[1] : trims[2];

  const funNames = [
    "Yellow Thunder","Route Rocket","Kindergarten Cruiser","Field Trip King",
    "The Honk Machine","Pothole Warrior","Sunrise Express","After-School Shuttle"
  ];

  const condition = randInt(92, 100);
  const price = msrpFor(year, trimShort) - (100 - condition) * 350;

  return {
    lotId: uid(),
    make: "Thomas Built Buses",
    model: trimName,
    year,
    name: `New ${year} ${trimShort} ‚Ä¢ ${pick(funNames)}`,
    price: Math.round(price),
    condition,
    warranty: randInt(2, 5)
  };
}

function generateLotForYear(year){
  const list = [];
  for(let i=0;i<6;i++) list.push(makeLotBus(year));

  if(Math.random() < 0.6){
    const leftovers = randInt(1, 2);
    for(let i=0;i<leftovers;i++){
      const b = makeLotBus(year - 1);
      b.name = `Leftover ${b.year} Deal ‚Ä¢ ${b.name.split("‚Ä¢").slice(-1)[0].trim()}`;
      b.price = Math.round(b.price * 0.90);
      list.push(b);
    }
  }

  state.lotInventory = list;
  save();
}

function refreshLot(){
  generateLotForYear(state.gameYear);
  renderAll();
}

function buyLotBus(lotId){
  const item = state.lotInventory.find(x => x.lotId === lotId);
  if(!item) return;
  if(state.wallet < item.price) return alert(`Not enough budget. Costs $${item.price.toLocaleString()}.`);

  state.wallet -= item.price;

  const newBus = {
    id: uid(),
    name: item.name,
    notes: `${item.make} ‚Ä¢ ${item.model} ‚Ä¢ Warranty: ${item.warranty}yr`,
    assignedDriverId: null,
    status: "active",
    maintenanceNote: "",
    subBusId: null,

    inServiceYear: item.year,
    odometer: 0,

    condition: item.condition,
    reliabilityMod: 0.05,
    serviceBoost: 10,

    lastInspectionYear: null,
    inspectionStatus: "unknown",

    lastPreTripDate: null,
    lastPostTripDate: null,
    preTripStreak: 0,

    defect: null,

    maintenance: { oilAt: 0, tiresAt: 0, brakesAt: 0 }
  };

  state.buses.push(newBus);
  state.lotInventory = state.lotInventory.filter(x => x.lotId !== lotId);

  save();
  renderAll();
  alert(`‚úÖ Purchased!\n${item.name}\n-$${item.price.toLocaleString()}`);
}

/* =========================
   BUSES
========================= */
function addBus(){
  const name = document.getElementById("busName").value.trim();
  const notes = document.getElementById("busNotes").value.trim();
  const year = Number(document.getElementById("busYear").value) || state.gameYear;

  if(!name) return alert("Enter a bus name.");
  state.buses.push({
    id: uid(),
    name,
    notes,
    assignedDriverId: null,
    status: "active",
    maintenanceNote: "",
    subBusId: null,

    inServiceYear: year,
    odometer: 0,

    condition: 70,
    reliabilityMod: 0,
    serviceBoost: 0,

    lastInspectionYear: null,
    inspectionStatus: "unknown",

    lastPreTripDate: null,
    lastPostTripDate: null,
    preTripStreak: 0,

    defect: null,

    maintenance: { oilAt: 0, tiresAt: 0, brakesAt: 0 }
  });

  document.getElementById("busName").value = "";
  document.getElementById("busNotes").value = "";
  document.getElementById("busYear").value = "";

  save();
  renderAll();
}

function busAge(bus){
  return Math.max(0, state.gameYear - Number(bus.inServiceYear || state.gameYear));
}

/* =========================
   MAINTENANCE INTERVALS
========================= */
function milesSinceService(bus, key){
  const at = Number(bus.maintenance?.[key+"At"] || 0);
  return Math.max(0, Number(bus.odometer || 0) - at);
}
function isOverdue(bus, key){
  return milesSinceService(bus, key) >= MAINT_INTERVALS[key];
}
function overdueSeverity(bus, key){
  const over = milesSinceService(bus, key) - MAINT_INTERVALS[key];
  return Math.max(0, over / MAINT_INTERVALS[key]);
}
function maintenanceRiskMultiplier(bus){
  let mult = 1.0;
  ["oil","tires","brakes"].forEach(k => {
    if(isOverdue(bus, k)){
      const sev = overdueSeverity(bus, k);
      mult *= (1.15 + Math.min(0.60, sev));
    }
  });
  return mult;
}

/* =========================
   PRE/POST TRIP + DEFECTS
========================= */
function doPreTrip(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses, busId);
  if(!bus) return;

  const t = todayISO();
  bus.lastPreTripDate = t;
  bus.preTripStreak = (bus.preTripStreak || 0) + 1;
  bus.condition = Math.min(100, Number(bus.condition || 70) + 0.5);

  state.logs.push({
    id: uid(), busId: bus.id, date: t, miles: 0,
    note: "‚úÖ Pre-Trip completed",
    createdAt: Date.now()
  });

  save(); renderAll();
  alert(`‚úÖ Pre-Trip complete for ${bus.name}`);
}

function doPostTrip(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses, busId);
  if(!bus) return;

  const t = todayISO();
  bus.lastPostTripDate = t;
  bus.condition = Math.min(100, Number(bus.condition || 70) + 0.3);

  state.logs.push({
    id: uid(), busId: bus.id, date: t, miles: 0,
    note: "‚úÖ Post-Trip completed",
    createdAt: Date.now()
  });

  save(); renderAll();
  alert(`‚úÖ Post-Trip complete for ${bus.name}`);
}

function reportDefect(){
  const busId = document.getElementById("checkBus").value;
  const bus = byId(state.buses, busId);
  if(!bus) return;

  const note = prompt("Describe the defect:");
  if(!note) return;

  const major = confirm("Is this a MAJOR defect?\n\nOK = Major (bus out of service)\nCancel = Minor");

  bus.defect = { level: major ? "major" : "minor", note, date: todayISO() };
  bus.lastPostTripDate = todayISO();

  if(major){
    bus.status = "down";
    bus.maintenanceNote = "Reported defect";
  }

  state.logs.push({
    id: uid(),
    busId: bus.id,
    date: todayISO(),
    miles: 0,
    note: `üö® Defect reported (${major ? "MAJOR" : "minor"}): ${note}`,
    createdAt: Date.now()
  });

  save();
  renderAll();

  alert(major ? `üöß MAJOR DEFECT\n${bus.name} is OUT OF SERVICE` : `‚ö†Ô∏è Minor defect logged for ${bus.name}`);
}

/* =========================
   GARAGE ACTIONS
========================= */
function repairCost(bus){
  const age = busAge(bus);
  const odo = Number(bus.odometer || 0);
  const base = 200 + age * 35 + (odo / 10000) * 60;
  const downPenalty = bus.status === "down" ? 200 : 0;
  return Math.round(base + downPenalty) * (state.board?.maintenanceMultiplier || 1.0);
}
function serviceCost(bus){
  const age = busAge(bus);
  return Math.round((120 + age * 15) * (state.board?.maintenanceMultiplier || 1.0));
}
function upgradeCost(bus){
  const age = busAge(bus);
  return Math.round((600 + age * 80) * (state.board?.maintenanceMultiplier || 1.0));
}
function retireValue(bus){
  const age = busAge(bus);
  const odo = Number(bus.odometer || 0);
  const v = 700 - age * 60 - (odo / 10000) * 50;
  return Math.max(50, Math.round(v));
}

function doRepair(busId){
  const bus = byId(state.buses, busId);
  if(!bus) return;
  const cost = Math.round(repairCost(bus));
  if(state.wallet < cost) return alert(`Not enough budget. Repair costs $${cost}.`);

  state.wallet -= cost;

  bus.status = "active";
  bus.maintenanceNote = "";
  bus.subBusId = null;

  bus.condition = Math.min(100, Number(bus.condition || 70) + 20);
  bus.defect = null;

  state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`üîß Repair: -$${cost}`, createdAt: Date.now() });

  save();
  renderAll();
}

function doService(busId){
  const bus = byId(state.buses, busId);
  if(!bus) return;
  const cost = Math.round(serviceCost(bus));
  if(state.wallet < cost) return alert(`Not enough budget. Service costs $${cost}.`);

  state.wallet -= cost;
  bus.serviceBoost = Math.min(30, Number(bus.serviceBoost || 0) + 10);
  bus.condition = Math.min(100, Number(bus.condition || 70) + 10);

  state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`üßΩ Service: -$${cost}`, createdAt: Date.now() });

  save();
  renderAll();
}

function doUpgrade(busId){
  const bus = byId(state.buses, busId);
  if(!bus) return;
  const cost = Math.round(upgradeCost(bus));
  if(state.wallet < cost) return alert(`Not enough budget. Upgrade costs $${cost}.`);

  state.wallet -= cost;
  bus.reliabilityMod = Math.min(0.25, Number(bus.reliabilityMod || 0) + 0.05);
  bus.condition = Math.min(100, Number(bus.condition || 70) + 8);

  state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`üß© Upgrade: -$${cost}`, createdAt: Date.now() });

  save();
  renderAll();
}

function serviceItem(busId, item){
  const bus = byId(state.buses, busId);
  if(!bus) return;

  const costs = { oil: 180, tires: 900, brakes: 650 };
  const baseCost = costs[item] || 200;
  const cost = Math.round(baseCost * (state.board?.maintenanceMultiplier || 1.0));
  if(state.wallet < cost) return alert(`Not enough budget. ${item.toUpperCase()} service costs $${cost}.`);

  state.wallet -= cost;

  if(!bus.maintenance) bus.maintenance = { oilAt: 0, tiresAt: 0, brakesAt: 0 };
  bus.maintenance[item + "At"] = Number(bus.odometer || 0);

  bus.condition = Math.min(100, Number(bus.condition || 70) + (item === "oil" ? 2 : item === "tires" ? 4 : 3));
  bus.defect = null;

  state.logs.push({
    id: uid(), busId: bus.id, date: todayISO(), miles: 0,
    note: `üõ†Ô∏è Serviced: ${item.toUpperCase()} (-$${cost})`,
    createdAt: Date.now()
  });

  save(); renderAll();
}

function doRetireBus(busId){
  const bus = byId(state.buses, busId);
  if(!bus) return;
  const value = retireValue(bus);

  if(!confirm(`Retire "${bus.name}" for $${value}? This removes it and its logs.`)) return;

  state.wallet += value;
  state.buses = state.buses.filter(b => b.id !== busId);
  state.logs = state.logs.filter(l => l.busId !== busId);

  Object.keys(state.routeAssignments).forEach(k=>{
    if(state.routeAssignments[k] === busId) state.routeAssignments[k] = "";
  });

  save(); renderAll();
}

/* =========================
   INSPECTIONS
========================= */
function inspectBus(busId){
  const bus = byId(state.buses, busId);
  if(!bus) return;

  const age = busAge(bus);
  const cond = Number(bus.condition || 70);

  let roll = Math.random() * 100;
  const strict = state.board?.inspectionStrictness || 1.0;
  roll *= (1/strict);

  let result = "pass";
  if(cond < 60 || roll < age * 3) result = "conditional";
  if(cond < 40 || roll < age * 1.5) result = "fail";

  bus.lastInspectionYear = state.gameYear;
  bus.inspectionStatus = result;

  if(result === "fail"){
    bus.status = "down";
    bus.maintenanceNote = "Failed inspection";
  }

  state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`üß™ Inspection: ${result.toUpperCase()}`, createdAt: Date.now() });

  save();
  renderAll();

  alert(`üß™ Inspection Result for ${bus.name}: ${result.toUpperCase()}`);
}

/* =========================
   BREAKDOWNS (older buses break more)
========================= */
function maybeAutoBreakWithRoute(bus, route, skippedPreTrip){
  if(bus.status !== "active") return;

  const age = busAge(bus);
  const odo = Number(bus.odometer || 0);

  const condition = Math.max(0, Math.min(100, Number(bus.condition || 70)));
  const reliabilityMod = Math.max(0, Math.min(0.25, Number(bus.reliabilityMod || 0)));
  const serviceBoost = Math.max(0, Math.min(30, Number(bus.serviceBoost || 0)));

  let chance = 0.02 + (age * 0.009) + (odo / 50000) * 0.03;
  chance *= (route?.risk || 1.0);
  chance *= (1.15 - (condition / 100) * 0.45);

  chance *= (1 - reliabilityMod);
  chance *= (1 - serviceBoost / 100);
  chance *= (state.board?.breakdownMod || 1.0);

  chance *= maintenanceRiskMultiplier(bus);

  if(bus.defect){
    chance *= bus.defect.level === "major" ? 2.0 : 1.25;
  }
  if(skippedPreTrip) chance *= 1.25;

  chance = Math.min(chance, 0.22);

  bus.serviceBoost = Math.max(0, serviceBoost - 2);
  const wearMod = state.board?.conditionWearMod || 1.0;
  bus.condition = Math.max(0, condition - (0.6 * wearMod));

  if(Math.random() > chance) return;

  const activeBuses = state.buses.filter(b => b.status === "active");
  if(activeBuses.length < 2){
    state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`‚ö†Ô∏è Near-breakdown avoided (no sub available)`, createdAt: Date.now() });
    return;
  }

  const events = [
    "Oil leak suspected after route",
    "Brake squeal turned into a warning light",
    "Cooling system acting up",
    "Electrical gremlin (again)",
    "Transmission slipping (old bus problems)"
  ];

  const candidates = activeBuses.filter(b => b.id !== bus.id);
  const subBus = candidates[Math.floor(Math.random() * candidates.length)];

  bus.status = "down";
  bus.maintenanceNote = events[Math.floor(Math.random() * events.length)];
  bus.subBusId = subBus.id;

  state.logs.push({ id: uid(), busId: bus.id, date: todayISO(), miles: 0, note:`üöß Breakdown: ${bus.maintenanceNote}`, createdAt: Date.now() });
}

/* =========================
   TRAINING + MENTOR + INCIDENTS
========================= */
function driverExperienceYears(d){
  return Math.max(0, state.gameYear - Number(d.hiredYear || state.gameYear));
}
function isTrainee(d){
  return d.training && d.training.stage === "in_training" && !d.isRetired;
}
function addBadge(driver, badge){
  if(!driver.badges) driver.badges = [];
  if(!driver.badges.includes(badge)) driver.badges.push(badge);
}
function applyTrainingIncidentIfAny(bus, driver, route){
  if(!isTrainee(driver)) return;

  let chance = 0.12;
  if(driver.mentorDriverId) chance *= 0.45;
  if(route.id === "neighborhood") chance *= 0.7;
  if(route.id === "field") chance *= 1.2;

  if(Math.random() > chance) return;

  const incidents = [
    { msg:"Missed a turn ‚Üí extra miles + wear", extraMiles: 3, extraWear: 2.0, payPenalty: 0 },
    { msg:"Hard braking complaint ‚Üí extra wear", extraMiles: 0, extraWear: 3.0, payPenalty: 0 },
    { msg:"Late paperwork ‚Üí pay reduced", extraMiles: 0, extraWear: 0, payPenalty: 40 },
    { msg:"Curb kiss ‚Üí tire check needed", extraMiles: 0, extraWear: 4.0, payPenalty: 0 }
  ];
  const e = incidents[Math.floor(Math.random()*incidents.length)];

  if(e.extraMiles){
    bus.odometer += e.extraMiles;
    state.logs.push({
      id: uid(), busId: bus.id, date: todayISO(), miles: e.extraMiles,
      note: `üéì Training incident: ${e.msg}`,
      createdAt: Date.now()
    });
  }

  if(e.extraWear){
    bus.condition = Math.max(0, Number(bus.condition || 70) - e.extraWear);
  }

  if(e.payPenalty){
    state.wallet = Math.max(0, Number(state.wallet || 0) - e.payPenalty);
  }

  alert(`üéì Training Incident!\n${driver.name}: ${e.msg}${e.payPenalty ? `\n-$${e.payPenalty}` : ""}`);
}

function processTrainingGraduations(){
  state.drivers.forEach(d => {
    if(d.isRetired) return;
    if(!d.training) return;

    if(d.training.stage === "in_training" && state.gameYear > d.training.startYear){
      d.trait = d.training.graduateTo || traitById("safe");
      d.training.stage = "graduated";

      addBadge(d, "Graduated Training");
      state.wallet += 150;

      if(d.mentorDriverId){
        const mentor = byId(state.drivers, d.mentorDriverId);
        if(mentor && !mentor.isRetired){
          addBadge(mentor, "Mentored a Graduate");
          state.wallet += 75;
        }
      }

      alert(`üèÖ Graduation!\n${d.name} graduated training.\nNew trait: ${d.trait.name}\n+$150 bonus`);
    }
  });
}

function isMentorEligible(d){
  return !d.isRetired && driverExperienceYears(d) >= 5;
}
function setMentor(){
  const traineeId = document.getElementById("mentorTrainee").value;
  const mentorId = document.getElementById("mentorMentor").value;
  const trainee = byId(state.drivers, traineeId);
  const mentor = byId(state.drivers, mentorId);

  if(!trainee || !mentor) return alert("Pick a trainee and a mentor.");
  if(!isTrainee(trainee)) return alert("That driver is not currently in training.");
  if(!isMentorEligible(mentor)) return alert("Mentor must have 5+ years experience.");

  trainee.mentorDriverId = mentor.id;
  save(); renderAll();
}
function clearMentor(){
  const traineeId = document.getElementById("mentorTrainee").value;
  const trainee = byId(state.drivers, traineeId);
  if(!trainee) return;
  trainee.mentorDriverId = null;
  save(); renderAll();
}

/* =========================
   HIRING (2 + 5)
========================= */
function generateName(){
  const first = ["Pat","Casey","Jordan","Taylor","Morgan","Riley","Avery","Sam","Cameron","Drew","Jamie","Alex"];
  const last  = ["Johnson","Miller","Davis","Clark","Lopez","Nguyen","Patel","Baker","Reed","Santos","Price","Hall"];
  return `${pick(first)} ${pick(last)}`;
}
function generateNick(){
  const nick = ["Smooth Stops","Turn Signal","Mirror Master","Radio Pro","Calm Captain","Pothole Dodger","Snack Patrol"];
  return `"${pick(nick)}"`;
}
function generatePoolCandidate(){
  const pool = ["safe","gentle","efficient","steady","rookie","rough","safe","gentle","efficient"];
  const trait = traitById(pick(pool));
  const expYears = randInt(0, 18);
  const hiredYear = state.gameYear - expYears;
  const cost = Math.round(200 + expYears * 25 + (trait.id === "safe" ? 80 : 0) + (trait.id === "rough" ? -40 : 0));
  return { candId: uid(), kind:"pool", name: generateName(), nick: generateNick(), hiredYear, trait, training:null, hireCost: Math.max(120, cost) };
}
function openHiringPool(){
  state.hiring.pool = [generatePoolCandidate(), generatePoolCandidate(), generatePoolCandidate()];
  save();
  renderAll();
}

function generateTrainingRookie(){
  const startTrait = traitById(pick(["rookie","rookie","steady","gentle"]));
  const gradTrait = traitById(pick(["safe","gentle","efficient","steady","safe"]));
  const tuition = 120;
  const stipend = 60;
  return {
    candId: uid(),
    kind:"training",
    name: generateName(),
    nick: generateNick(),
    hiredYear: state.gameYear,
    trait: startTrait,
    training: { startYear: state.gameYear, stage: "in_training", graduateTo: gradTrait },
    hireCost: Math.max(0, tuition - stipend)
  };
}
function openTrainingProgram(){
  state.hiring.pool = [generateTrainingRookie(), generateTrainingRookie(), generateTrainingRookie()];
  save();
  renderAll();
}

function hireCandidate(candId){
  const c = state.hiring.pool.find(x => x.candId === candId);
  if(!c) return;

  if(state.wallet < c.hireCost){
    return alert(`Not enough budget. Hiring costs $${c.hireCost.toLocaleString()}.`);
  }

  state.wallet -= c.hireCost;

  state.drivers.push({
    id: uid(),
    name: c.name,
    nick: c.nick,
    status: "available",
    hiredYear: c.hiredYear,
    trait: c.trait,
    training: c.training || null,
    mentorDriverId: null,
    badges: [],
    isRetired: false,
    retiredYear: null
  });

  state.hiring.pool = [];
  save();
  renderAll();

  const d = state.drivers[state.drivers.length - 1];
  alert(`‚úÖ Hired ${d.name}\nTrait: ${d.trait.name}\nExperience: ${driverExperienceYears(d)} year(s)\nCost: $${c.hireCost.toLocaleString()}`);
}

/* =========================
   DRIVERS + RETIREMENT
========================= */
function addDriver(){
  const name = document.getElementById("driverName").value.trim();
  const nick = document.getElementById("driverNick").value.trim();
  const hiredYear = Number(document.getElementById("driverYear").value) || state.gameYear;

  if(!name) return alert("Enter a driver name.");

  state.drivers.push({
    id: uid(),
    name,
    nick,
    status: "available",
    hiredYear,
    trait: randomDriverTrait(),
    training: null,
    mentorDriverId: null,
    badges: [],
    isRetired: false,
    retiredYear: null
  });

  document.getElementById("driverName").value = "";
  document.getElementById("driverNick").value = "";
  document.getElementById("driverYear").value = "";

  save();
  renderAll();
}

function retireDriverById(driverId, reason="Manual retirement"){
  const d = byId(state.drivers, driverId);
  if(!d || d.isRetired) return;

  d.isRetired = true;
  d.retiredYear = state.gameYear;
  d.status = "vacation";

  state.buses.forEach(b => {
    if(b.assignedDriverId === d.id) b.assignedDriverId = null;
  });

  state.logs.push({ id: uid(), busId: "", date: todayISO(), miles: 0, note:`üéâ Driver retired: ${d.name} (${reason})`, createdAt: Date.now() });

  save();
  renderAll();

  alert(`üéâ ${d.name} retired!\nReason: ${reason}`);
}

function processDriverRetirements(){
  const HARD_RETIRE = 25;
  state.drivers.forEach(d => {
    if(d.isRetired) return;

    const yrs = driverExperienceYears(d);

    if(yrs >= HARD_RETIRE){
      retireDriverById(d.id, "Reached retirement years");
      return;
    }

    if(yrs >= 20){
      const chance = Math.min(0.25, 0.05 + (yrs - 20) * 0.03);
      if(Math.random() < chance){
        retireDriverById(d.id, "Chose to retire");
      }
    }
  });
}

function setDriverStatus(driverId, status){
  const d = byId(state.drivers, driverId);
  if(!d) return;
  d.status = status;
  save();
  renderAll();
}

/* =========================
   ROUTE RUNNERS
========================= */
function getDispatchShift(){
  const el = document.getElementById("dispatchShift");
  return (el && el.value) ? el.value : "morning";
}

function runRoute(){
  const busId = document.getElementById("routeBus").value;
  const driverId = document.getElementById("routeDriver").value;
  const routeId = document.getElementById("routeType").value;

  const bus = byId(state.buses, busId);
  const driver = byId(state.drivers, driverId);
  const route = allRoutes().find(r => r.id === routeId);

  if(!bus || !driver || !route) return alert("Select bus, driver, and route.");
  if(bus.status === "down") return alert("Bus is down. Use a different bus (or repair it).");
  if(driver.isRetired) return alert("Driver is retired.");
  if(driver.status !== "available") return alert(`${driver.name} is unavailable.`);

  const t = todayISO();
  const skippedPreTrip = (bus.lastPreTripDate !== t);
  if(skippedPreTrip){
    if(!confirm(`‚ö†Ô∏è Pre-Trip not completed for ${bus.name} today.\nRun anyway? (Higher risk)`)) return;
  }

  const shift = getDispatchShift();
  const rules = SHIFT_RULES[shift] || SHIFT_RULES.morning;

  state.logs.push({
    id: uid(),
    busId,
    date: t,
    miles: route.miles,
    note: `${route.name} (AD-HOC ${shift.toUpperCase()})`,
    createdAt: Date.now()
  });

  bus.odometer = Number(bus.odometer || 0) + route.miles;

  let wear = route.wear * 1.2 * rules.wearMult;
  wear *= (1 + (maintenanceRiskMultiplier(bus) - 1) * 0.6);
  if(skippedPreTrip) wear *= 1.15;
  if(bus.defect) wear *= bus.defect.level === "major" ? 1.25 : 1.10;
  wear *= (state.board?.conditionWearMod || 1.0);

  bus.condition = Math.max(0, Number(bus.condition || 70) - wear);

  let pay = Math.round(route.pay * rules.payMult);
  state.wallet = Number(state.wallet || 0) + pay;

  applyTrainingIncidentIfAny(bus, driver, route);
  maybeAutoBreakWithRoute(bus, route, skippedPreTrip);

  save();
  renderAll();

  alert(`üöå ${route.name} completed!\nBus: ${bus.name}\nDriver: ${driver.name}\n+$${pay} ‚Ä¢ ${route.miles} miles`);
}

/* =========================
   ROUTE ASSIGNMENTS + DISPATCH
========================= */
function setAssignedBus(routeId, busId){
  if(!state.routeAssignments) state.routeAssignments = {};
  state.routeAssignments[routeId] = busId || "";
  save();
  renderAll();
}

function pickSubBus(excludeBusId){
  const options = state.buses.filter(b => b.status === "active" && b.id !== excludeBusId);
  if(options.length === 0) return null;

  const list = options.map((b, i) => `${i+1}) ${b.name}`).join("\n");
  const choice = prompt(`Assigned bus is DOWN.\nPick a Sub Bus:\n\n${list}\n\nEnter number:`);
  const idx = Number(choice) - 1;
  if(!Number.isFinite(idx) || idx < 0 || idx >= options.length) return null;
  return options[idx];
}

function dispatchKey(){ return todayISO(); }

function ensureDispatchDay(){
  const key = dispatchKey();
  if(!state.dispatch[key]) state.dispatch[key] = { morning:{}, afternoon:{} };

  ["morning","afternoon"].forEach(shift => {
    dailyRoutes().forEach(r => {
      if(!state.dispatch[key][shift][r.id]) state.dispatch[key][shift][r.id] = { driverId: "" };
    });
  });
}

function setDispatchDriver(routeId, driverId){
  ensureDispatchDay();
  const key = dispatchKey();
  const shift = getDispatchShift();
  state.dispatch[key][shift][routeId].driverId = driverId || "";
  save();
  renderAll();
}

function getDispatchDriver(routeId){
  ensureDispatchDay();
  const key = dispatchKey();
  const shift = getDispatchShift();
  return state.dispatch[key][shift]?.[routeId]?.driverId || "";
}

function driverDisplay(d){
  const yrs = driverExperienceYears(d);
  const trait = d.trait?.name ? ` ‚Ä¢ ${d.trait.name}` : "";
  return `${d.name} (${yrs}y${trait})`;
}

function runScheduledRouteWithDriver(routeId, driverId){
  const route = allRoutes().find(r => r.id === routeId);
  if(!route) return alert("Route not found.");

  const assignedBusId = state.routeAssignments?.[routeId] || "";
  if(!assignedBusId) return alert(`No bus assigned to ${route.name}. Assign one first.`);

  const assignedBus = byId(state.buses, assignedBusId);
  if(!assignedBus) return alert("Assigned bus no longer exists. Reassign this route.");

  const driver = byId(state.drivers, driverId);
  if(!driverId || !driver) return alert("Pick a driver for this route.");
  if(driver.isRetired) return alert("That driver is retired.");
  if(driver.status !== "available") return alert(`${driver.name} is not available today.`);

  let busToUse = assignedBus;
  let usedSub = false;

  if(assignedBus.status === "down"){
    const sub = pickSubBus(assignedBus.id);
    if(!sub) return alert("No sub bus selected (or none available). Route not run.");
    busToUse = sub;
    usedSub = true;
  }

  const t = todayISO();
  const skippedPreTrip = (busToUse.lastPreTripDate !== t);
  if(skippedPreTrip){
    const ok = confirm(`‚ö†Ô∏è Pre-Trip not completed for ${busToUse.name} today.\nRun anyway?`);
    if(!ok) return;
  }

  const shift = getDispatchShift();
  const rules = SHIFT_RULES[shift] || SHIFT_RULES.morning;

  state.logs.push({
    id: uid(),
    busId: busToUse.id,
    date: t,
    miles: route.miles,
    note: usedSub
      ? `${route.name} (${shift.toUpperCase()} ‚Ä¢ SUB for ${assignedBus.name})`
      : `${route.name} (${shift.toUpperCase()} ‚Ä¢ Assigned)`,
    createdAt: Date.now()
  });

  busToUse.odometer = Number(busToUse.odometer || 0) + route.miles;

  let wear = route.wear * 1.2 * rules.wearMult;
  wear *= (1 + (maintenanceRiskMultiplier(busToUse) - 1) * 0.6);
  if(skippedPreTrip) wear *= 1.15;
  if(busToUse.defect) wear *= busToUse.defect.level === "major" ? 1.25 : 1.10;
  wear *= (state.board?.conditionWearMod || 1.0);

  busToUse.condition = Math.max(0, Number(busToUse.condition || 70) - wear);

  let pay = Math.round(route.pay * rules.payMult);
  if(usedSub) pay = Math.max(0, pay - SUB_LATE_PENALTY);

  if(state.board?.driverPolicy === "strict" && usedSub){
    const extra = Number(state.board.subCostPerRoute || 0);
    state.wallet = Math.max(0, Number(state.wallet || 0) - extra);
  }

  state.wallet = Number(state.wallet || 0) + pay;

  applyTrainingIncidentIfAny(busToUse, driver, route);
  maybeAutoBreakWithRoute(busToUse, route, skippedPreTrip);

  save();
  renderAll();

  alert(
    `‚úÖ Dispatched ${route.name} (${shift.toUpperCase()})\n` +
    `Bus: ${busToUse.name}${usedSub ? ` (SUB for ${assignedBus.name})` : ""}\n` +
    `Driver: ${driver.name}\n` +
    `+$${pay} ‚Ä¢ ${route.miles} miles` +
    (usedSub ? `\n(Late start penalty: -$${SUB_LATE_PENALTY})` : "")
  );
}

function runAllScheduled(){
  ensureDispatchDay();
  const routes = dailyRoutes();

  for(const r of routes){
    const driverId = getDispatchDriver(r.id);
    if(!driverId){
      alert(`Missing driver for: ${r.name}\nAssign drivers in Dispatch View first.`);
      return;
    }
  }

  for(const r of routes){
    runScheduledRouteWithDriver(r.id, getDispatchDriver(r.id));
  }
}

/* =========================
   SCHOOL BOARD
========================= */
function quarterKey(){
  const now = new Date();
  const q = Math.floor(now.getMonth() / 3) + 1;
  return `${state.gameYear}-${q}`;
}

function holdBoardMeeting(){
  const key = quarterKey();
  state.board.lastMeetingKey = key;
  state.board.activeProposals = generateBoardProposals();
  save();
  renderAll();
}

function generateBoardProposals(){
  const proposals = [];

  const base = [
    {
      title: "Fleet Safety Initiative Grant",
      desc: "State grant opportunity if you commit to stronger inspections this year.",
      impactText: "+$3,000 budget, but inspections get stricter.",
      applyYes(){
        state.wallet += 3000;
        state.board.inspectionStrictness = Math.min(1.5, state.board.inspectionStrictness + 0.15);
      },
      applyNo(){}
    },
    {
      title: "Budget Freeze",
      desc: "Board wants to pause extra spending due to district finances.",
      impactText: "Next-year allocation reduced.",
      applyYes(){
        state.board.nextYearAllocationMod = (state.board.nextYearAllocationMod || 1.0) * 0.85;
      },
      applyNo(){}
    },
    {
      title: "Preventive Maintenance Mandate",
      desc: "Extra PM checks to reduce breakdowns (more cost, less wear).",
      impactText: "Maintenance costs ‚Üë, condition wear ‚Üì.",
      applyYes(){
        state.board.maintenanceMultiplier = Math.min(1.5, state.board.maintenanceMultiplier + 0.15);
        state.board.conditionWearMod = (state.board.conditionWearMod || 1.0) * 0.85;
      },
      applyNo(){}
    },
    {
      title: "Strict Driver Policy",
      desc: "Coverage must be planned. Sub operations cost money, fewer breakdowns.",
      impactText: "Subs cost $40 per route, breakdowns ‚Üì a bit.",
      applyYes(){
        state.board.driverPolicy = "strict";
        state.board.subCostPerRoute = 40;
        state.board.breakdownMod = (state.board.breakdownMod || 1.0) * 0.9;
      },
      applyNo(){
        state.board.driverPolicy = "standard";
        state.board.subCostPerRoute = 0;
      }
    },
    {
      title: "Replace Oldest Bus",
      desc: "Board wants optics: retire one bus older than 15 years (if any).",
      impactText: "Retire 1 old bus, then +$1,500 credit.",
      applyYes(){
        const year = state.gameYear;
        const old = state.buses
          .map(b => ({ b, age: Math.max(0, year - (b.inServiceYear || year)) }))
          .filter(x => x.age >= 15)
          .sort((a,b)=> b.age - a.age)[0];

        if(old){
          const busId = old.b.id;
          state.buses = state.buses.filter(b => b.id !== busId);
          state.logs = state.logs.filter(l => l.busId !== busId);
          Object.keys(state.routeAssignments).forEach(k=>{
            if(state.routeAssignments[k] === busId) state.routeAssignments[k] = "";
          });
          state.wallet += 1500;
        } else {
          state.wallet += 300;
        }
      },
      applyNo(){}
    }
  ];

  const count = randInt(2,3);
  const pool = [...base];
  for(let i=0;i<count;i++){
    const idx = randInt(0, pool.length-1);
    proposals.push(pool.splice(idx,1)[0]);
  }

  return proposals;
}

function voteProposal(idx, yes){
  const p = state.board.activeProposals?.[idx];
  if(!p) return;

  if(yes) p.applyYes(); else p.applyNo();

  state.logs.push({ id: uid(), busId: "", date: todayISO(), miles: 0, note:`üó≥Ô∏è Board vote: ${p.title} ‚Üí ${yes ? "YES" : "NO"}`, createdAt: Date.now() });

  state.board.activeProposals.splice(idx,1);
  if(state.board.activeProposals.length === 0) delete state.board.activeProposals;

  save();
  renderAll();
}

/* =========================
   YEAR ADVANCE
========================= */
function advanceYear(){
  state.gameYear += 1;

  const mod = state.board?.nextYearAllocationMod || 1.0;
  const allocation = Math.round(2500 * mod);
  state.wallet = Math.round((state.wallet || 0) + allocation);

  generateLotForYear(state.gameYear);
  processTrainingGraduations();
  processDriverRetirements();

  save();
  renderAll();

  alert(`üìÖ New Year: ${state.gameYear}\nüí∞ Allocation: +$${allocation.toLocaleString()}`);
}

/* =========================
   BACKUP / RESTORE / RESET
========================= */
function backupData(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `busboss_backup_${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function restoreData(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const file = inp.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result));
        localStorage.setItem("busboss_v1", JSON.stringify(obj));
        location.reload();
      }catch(e){
        alert("Invalid backup file.");
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}

function resetAll(){
  if(!confirm("Reset everything? This clears all buses/drivers/routes/logs.")) return;
  localStorage.removeItem("busboss_v1");
  location.reload();
}

/* =========================
   RENDERING
========================= */
function setSelect(id, optionsHtml){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = optionsHtml;
}

function renderTop(){
  document.getElementById("walletTop").textContent = `$${Number(state.wallet||0).toLocaleString()}`;
  document.getElementById("gameYearTop").textContent = String(state.gameYear);
}

function renderFleet(){
  if(!state.buses.length){
    document.getElementById("fleetPanel").innerHTML = `<div class="muted">No buses yet. Add one or buy from the lot.</div>`;
    return;
  }

  const rows = state.buses.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(b=>{
    const age = busAge(b);
    const odo = Number(b.odometer||0);
    const cond = Math.round(Number(b.condition||70));
    const status = b.status === "down"
      ? `üöß DOWN <span class="small muted">Sub: ${escapeHtml(byId(state.buses, b.subBusId)?.name || "None")}</span><div class="small muted">${escapeHtml(b.maintenanceNote || "")}</div>`
      : `‚úÖ Active`;

    const defectLine = b.defect
      ? `üö® ${b.defect.level.toUpperCase()} DEFECT: ${escapeHtml(b.defect.note)}`
      : `No reported defects`;

    return `
      <tr>
        <td>
          <div><strong>${escapeHtml(b.name)}</strong></div>
          <div class="small muted">Age: ${age} yrs ‚Ä¢ Odo: ${fmtMiles(odo)} mi ‚Ä¢ Condition: ${cond}/100</div>
          <div class="small">${status}</div>
          <div class="small muted">${defectLine}</div>
        </td>
        <td class="right nowrap">
          <button onclick="inspectBus('${b.id}')">Inspect</button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("fleetPanel").innerHTML = `
    <table>
      <thead><tr><th>Bus</th><th class="right">Actions</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderGarage(){
  document.getElementById("walletGarage").textContent = `$${Number(state.wallet||0).toLocaleString()}`;

  if(!state.buses.length){
    document.getElementById("garage").innerHTML = `<div class="muted">No buses yet.</div>`;
    return;
  }

  const rows = state.buses.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(b=>{
    const age = busAge(b);
    const odo = Number(b.odometer||0);
    const cond = Math.round(Number(b.condition||70));
    const rep = Math.round(repairCost(b));
    const svc = Math.round(serviceCost(b));
    const upg = Math.round(upgradeCost(b));
    const rv  = retireValue(b);

    const oilDue = isOverdue(b,"oil") ? "üõ¢Ô∏è OIL OVERDUE" : "Oil OK";
    const tireDue = isOverdue(b,"tires") ? "üõû TIRES OVERDUE" : "Tires OK";
    const brakeDue = isOverdue(b,"brakes") ? "üõë BRAKES OVERDUE" : "Brakes OK";

    const defectLine = b.defect
      ? `üö® ${b.defect.level.toUpperCase()} DEFECT: ${escapeHtml(b.defect.note)}`
      : `No reported defects`;

    const status = b.status === "down"
      ? `üöß DOWN ‚Äî Sub: ${escapeHtml(byId(state.buses, b.subBusId)?.name || "None")}<div class="small muted">${escapeHtml(b.maintenanceNote||"")}</div>`
      : `‚úÖ Active`;

    return `
      <tr>
        <td>
          <div><strong>${escapeHtml(b.name)}</strong></div>
          <div class="small muted">Age: ${age} yrs ‚Ä¢ Odo: ${fmtMiles(odo)} mi ‚Ä¢ Condition: ${cond}/100</div>
          <div class="small">${status}</div>
          <div class="small muted">${oilDue} ‚Ä¢ ${tireDue} ‚Ä¢ ${brakeDue}</div>
          <div class="small muted">${defectLine}</div>
        </td>
        <td class="right nowrap">
          <div class="row" style="justify-content:flex-end;">
            <button onclick="doRepair('${b.id}')" ${state.wallet < rep ? "disabled":""}>Repair ($${rep})</button>
            <button onclick="doService('${b.id}')" ${state.wallet < svc ? "disabled":""}>Service ($${svc})</button>
            <button onclick="doUpgrade('${b.id}')" ${state.wallet < upg ? "disabled":""}>Upgrade ($${upg})</button>
            <button onclick="serviceItem('${b.id}','oil')">Oil</button>
            <button onclick="serviceItem('${b.id}','tires')">Tires</button>
            <button onclick="serviceItem('${b.id}','brakes')">Brakes</button>
            <button class="danger" onclick="doRetireBus('${b.id}')">Retire (+$${rv})</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("garage").innerHTML = `
    <table>
      <thead><tr><th>Bus</th><th class="right">Garage Actions</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderBusLot(){
  document.getElementById("gameYear").textContent = String(state.gameYear);

  if(!state.lotInventory.length){
    document.getElementById("busLot").innerHTML =
      `<div class="muted">Lot is empty. Click ‚ÄúRefresh Lot‚Äù.</div>`;
    return;
  }

  const rows = state.lotInventory
    .slice()
    .sort((a,b)=> (b.year - a.year) || (a.price - b.price))
    .map(b => {
      const canBuy = state.wallet >= b.price;
      return `
        <tr>
          <td>
            <div><strong>${escapeHtml(b.name)}</strong></div>
            <div class="small muted">${escapeHtml(b.make)} ‚Ä¢ ${escapeHtml(b.model)} ‚Ä¢ Year: ${b.year} ‚Ä¢ Condition: ${b.condition}/100 ‚Ä¢ Warranty: ${b.warranty}yr</div>
          </td>
          <td class="mono nowrap">$${b.price.toLocaleString()}</td>
          <td class="right nowrap">
            <button class="primary" onclick="buyLotBus('${b.lotId}')" ${canBuy ? "" : "disabled"}>Buy</button>
          </td>
        </tr>
      `;
    }).join("");

  document.getElementById("busLot").innerHTML = `
    <table>
      <thead><tr><th>Available Buses</th><th class="nowrap">Price</th><th class="right">Action</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderDrivers(){
  if(!state.drivers.length){
    document.getElementById("driversPanel").innerHTML = `<div class="muted">No drivers yet. Add one or hire.</div>`;
    return;
  }

  const rows = state.drivers.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(d=>{
    const yrs = driverExperienceYears(d);
    const traitName = d.trait?.name || "‚Äî";
    const retiredBadge = d.isRetired ? ` <span class="pill" style="border-color:#c33">Retired</span>` : "";
    const badges = (d.badges && d.badges.length) ? d.badges.map(b => `<span class="pill">${escapeHtml(b)}</span>`).join(" ") : "";
    const mentor = d.mentorDriverId ? byId(state.drivers, d.mentorDriverId) : null;
    const mentorLine = isTrainee(d) ? `<div class="small muted">Mentor: ${escapeHtml(mentor?.name || "None")}</div>` : "";

    return `
      <tr>
        <td>
          <strong>${escapeHtml(d.name)}</strong>${retiredBadge}
          <div class="small muted">${escapeHtml(d.nick || "")}</div>
          <div class="small muted">${yrs} yrs ‚Ä¢ Trait: ${escapeHtml(traitName)}</div>
          ${mentorLine}
          <div class="small">${badges}</div>
        </td>
        <td class="nowrap">
          <select onchange="setDriverStatus('${d.id}', this.value)" ${d.isRetired ? "disabled":""}>
            <option value="available" ${d.status==="available"?"selected":""}>‚úÖ Available</option>
            <option value="sick" ${d.status==="sick"?"selected":""}>ü§í Sick</option>
            <option value="vacation" ${d.status==="vacation"?"selected":""}>üèñÔ∏è Vacation</option>
            <option value="sub" ${d.status==="sub"?"selected":""}>üßë‚Äçüîß Sub</option>
          </select>
        </td>
        <td class="right nowrap">
          <button onclick="retireDriverById('${d.id}')" ${d.isRetired ? "disabled":""}>Retire</button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("driversPanel").innerHTML = `
    <table>
      <thead><tr><th>Driver</th><th>Status</th><th class="right">Actions</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderHiringPanel(){
  const panel = document.getElementById("hiringPanel");
  if(!panel) return;

  if(!state.hiring.pool || !state.hiring.pool.length){
    panel.innerHTML = `<div class="muted">No candidates right now. Open the Hiring Pool or Training Program.</div>`;
    return;
  }

  panel.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Candidate</th>
          <th>Trait</th>
          <th class="nowrap">Experience</th>
          <th class="nowrap">Cost</th>
          <th class="right">Action</th>
        </tr>
      </thead>
      <tbody>
        ${state.hiring.pool.map(c => {
          const yrs = Math.max(0, state.gameYear - Number(c.hiredYear || state.gameYear));
          const tag = c.kind === "training" ? "üéì Training" : "üé§ Pool";
          const extra = c.kind === "training"
            ? `<div class="small muted">Graduates next year ‚Üí ${escapeHtml(c.training.graduateTo.name)}</div>`
            : `<div class="small muted">${tag}</div>`;
          const canHire = state.wallet >= c.hireCost;

          return `
            <tr>
              <td>
                <strong>${escapeHtml(c.name)}</strong> <span class="pill">${tag}</span>
                <div class="small muted">${escapeHtml(c.nick || "")}</div>
                ${extra}
              </td>
              <td>${escapeHtml(c.trait.name)}</td>
              <td class="nowrap">${yrs} yr(s)</td>
              <td class="nowrap mono">$${Number(c.hireCost).toLocaleString()}</td>
              <td class="right nowrap">
                <button class="primary" onclick="hireCandidate('${c.candId}')" ${canHire ? "" : "disabled"}>Hire</button>
              </td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
}

function renderMentorDropdowns(){
  const tSel = document.getElementById("mentorTrainee");
  const mSel = document.getElementById("mentorMentor");
  if(!tSel || !mSel) return;

  const trainees = state.drivers.filter(isTrainee);
  const mentors = state.drivers.filter(isMentorEligible);

  tSel.innerHTML = trainees.map(d => {
    const yrs = driverExperienceYears(d);
    return `<option value="${d.id}">${escapeHtml(d.name)} (${yrs}y)</option>`;
  }).join("") || `<option value="">No trainees</option>`;

  mSel.innerHTML = mentors.map(d => {
    const yrs = driverExperienceYears(d);
    return `<option value="${d.id}">${escapeHtml(d.name)} (${yrs}y)</option>`;
  }).join("") || `<option value="">No mentors</option>`;
}

function renderRouteAssignments(){
  const panel = document.getElementById("routeAssignmentsPanel");
  if(!panel) return;

  const buses = state.buses.slice().sort((a,b)=> a.name.localeCompare(b.name));
  const busOpts = (selectedId) =>
    `<option value="">‚Äî Unassigned ‚Äî</option>` +
    buses.map(b => {
      const downTag = b.status === "down" ? " üöß" : "";
      return `<option value="${b.id}" ${b.id===selectedId ? "selected":""}>${escapeHtml(b.name)}${downTag}</option>`;
    }).join("");

  const rows = dailyRoutes().map(r => {
    const assignedId = state.routeAssignments?.[r.id] || "";
    const assigned = byId(state.buses, assignedId);
    const status = !assigned
      ? `<span class="pill" style="border-color:#c33">NO BUS</span>`
      : assigned.status === "down"
        ? `<span class="pill" style="border-color:#c33">DOWN</span>`
        : `<span class="pill">Active</span>`;

    return `
      <tr>
        <td>
          <strong>${escapeHtml(r.name)}</strong>
          <div class="small muted">${r.miles} mi ‚Ä¢ +$${r.pay} ‚Ä¢ Wear x${r.wear}</div>
        </td>
        <td>
          <select onchange="setAssignedBus('${r.id}', this.value)">
            ${busOpts(assignedId)}
          </select>
        </td>
        <td>${status}</td>
      </tr>
    `;
  }).join("");

  panel.innerHTML = `
    <table>
      <thead><tr><th>Daily Route</th><th>Assigned Bus</th><th>Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="small muted" style="margin-top:8px;">Ad-hoc routes are run from the Ad-hoc runner.</div>
  `;
}

function renderDispatch(){
  ensureDispatchDay();
  const key = dispatchKey();
  document.getElementById("dispatchDate").textContent = key;

  const shift = getDispatchShift();
  const rules = SHIFT_RULES[shift] || SHIFT_RULES.morning;

  const panel = document.getElementById("dispatchPanel");
  if(!panel) return;

  const availableDrivers = state.drivers
    .filter(d => !d.isRetired && d.status === "available")
    .sort((a,b)=> a.name.localeCompare(b.name));

  const driverOptions = (selectedId) =>
    `<option value="">‚Äî Select driver ‚Äî</option>` +
    availableDrivers.map(d => `
      <option value="${d.id}" ${d.id===selectedId ? "selected":""}>${escapeHtml(driverDisplay(d))}</option>
    `).join("");

  const rows = dailyRoutes().map(r => {
    const busId = state.routeAssignments?.[r.id] || "";
    const bus = byId(state.buses, busId);
    const driverId = getDispatchDriver(r.id);

    const busText = bus ? escapeHtml(bus.name) : "Unassigned";
    const busStatus = !bus
      ? `<span class="pill" style="border-color:#c33">NO BUS</span>`
      : bus.status === "down"
        ? `<span class="pill" style="border-color:#c33">DOWN (SUB REQUIRED)</span>`
        : `<span class="pill">Active</span>`;

    const preTripOk = bus && bus.lastPreTripDate === key;
    const preTripTag = bus
      ? (preTripOk ? `<span class="pill">Pre-Trip ‚úÖ</span>` : `<span class="pill" style="border-color:#c90">Pre-Trip ‚ö†Ô∏è</span>`)
      : "";

    const payShown = Math.round(r.pay * rules.payMult);

    return `
      <tr>
        <td>
          <strong>${escapeHtml(r.name)}</strong>
          <div class="small muted">${r.miles} mi ‚Ä¢ +$${payShown} (${shift}) ‚Ä¢ Wear x${(r.wear * rules.wearMult).toFixed(2)}</div>
        </td>
        <td>
          <div>${busText}</div>
          <div class="small">${busStatus} ${preTripTag}</div>
        </td>
        <td>
          <select onchange="setDispatchDriver('${r.id}', this.value)">
            ${driverOptions(driverId)}
          </select>
        </td>
        <td class="right nowrap">
          <button class="primary" onclick="runScheduledRouteWithDriver('${r.id}', getDispatchDriver('${r.id}'))">Run</button>
        </td>
      </tr>
    `;
  }).join("");

  panel.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Route</th>
          <th>Assigned Bus</th>
          <th>Today‚Äôs Driver (${escapeHtml(shift)})</th>
          <th class="right">Dispatch</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="small muted" style="margin-top:8px;">
      Field Trips & ad-hoc custom routes stay in the Ad-hoc Route Runner.
    </div>
  `;
}

function renderBoard(){
  const pol = state.board.driverPolicy === "strict" ? "Strict Driver Policy" : "Standard Policy";
  document.getElementById("boardPolicy").textContent =
    `${pol} ‚Ä¢ Maint x${Number(state.board.maintenanceMultiplier||1).toFixed(2)} ‚Ä¢ Inspect x${Number(state.board.inspectionStrictness||1).toFixed(2)}`;

  const panel = document.getElementById("boardPanel");
  if(!panel) return;

  if(!state.board.activeProposals){
    panel.innerHTML = `<div class="muted">No active proposals. Click ‚ÄúBoard Meeting‚Äù.</div>`;
    return;
  }

  panel.innerHTML = state.board.activeProposals.map((p, idx) => `
    <div class="card" style="margin:10px 0;">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <div>
          <div><strong>${escapeHtml(p.title)}</strong></div>
          <div class="small muted">${escapeHtml(p.desc)}</div>
          <div class="small">Impact: ${escapeHtml(p.impactText)}</div>
        </div>
        <div class="row">
          <button class="primary" onclick="voteProposal(${idx}, true)">Vote YES</button>
          <button onclick="voteProposal(${idx}, false)">Vote NO</button>
        </div>
      </div>
    </div>
  `).join("") + `<div class="small muted">Vote all items to end the meeting.</div>`;
}

function renderLog(){
  const panel = document.getElementById("logPanel");
  if(!panel) return;

  const items = state.logs.slice().sort((a,b)=> (b.createdAt||0) - (a.createdAt||0)).slice(0,20);
  if(!items.length){
    panel.innerHTML = `<div class="muted">No activity yet.</div>`;
    return;
  }

  panel.innerHTML = `
    <table>
      <thead><tr><th>Date</th><th>Bus</th><th>Note</th><th class="right">Miles</th></tr></thead>
      <tbody>
        ${items.map(l=>{
          const busName = l.busId ? (byId(state.buses, l.busId)?.name || "‚Äî") : "‚Äî";
          return `
            <tr>
              <td class="mono nowrap">${escapeHtml(l.date || "")}</td>
              <td>${escapeHtml(busName)}</td>
              <td>${escapeHtml(l.note || "")}</td>
              <td class="right mono nowrap">${Number(l.miles||0) ? fmtMiles(l.miles) : ""}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
}

function renderSchoolYearSettings(){
  document.getElementById("syMonth").value = String(state.schoolYear.startMonth || 8);
  document.getElementById("syDay").value = String(state.schoolYear.startDay || 1);
}

function renderAll(){
  renderTop();

  const busOptions =
    `<option value="">‚Äî Select bus ‚Äî</option>` +
    state.buses.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(b=>{
      const down = b.status === "down" ? " üöß" : "";
      return `<option value="${b.id}">${escapeHtml(b.name)}${down}</option>`;
    }).join("");

  const driverOptions =
    `<option value="">‚Äî Select driver ‚Äî</option>` +
    state.drivers
      .filter(d => !d.isRetired)
      .slice()
      .sort((a,b)=>a.name.localeCompare(b.name))
      .map(d=>{
        const yrs = driverExperienceYears(d);
        const t = d.trait?.name ? ` ‚Ä¢ ${d.trait.name}` : "";
        const statusTag = d.status !== "available" ? ` (${d.status})` : "";
        return `<option value="${d.id}">${escapeHtml(d.name)} (${yrs}y${escapeHtml(t)})${escapeHtml(statusTag)}</option>`;
      }).join("");

  setSelect("routeBus", busOptions);
  setSelect("routeDriver", driverOptions);
  setSelect("checkBus", busOptions);

  const routeType = document.getElementById("routeType");
  if(routeType){
    routeType.innerHTML = adHocRoutes().map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join("");
    routeType.value = "field";
  }

  renderCustomRoutes();
  renderFleet();
  renderGarage();
  renderBusLot();
  renderDrivers();
  renderHiringPanel();
  renderMentorDropdowns();
  renderRouteAssignments();
  renderDispatch();
  renderBoard();
  renderLog();
  renderSchoolYearSettings();

  maybeAutoStartNewSchoolYear();
}

renderAll();
</script>
</body>
</html>
